<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/WebDapp/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HRKey - Sign In</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    window.__SUPABASE_URL__ = "https://wrervcydgdrlcndtjboy.supabase.co";
    window.__SUPABASE_ANON_KEY__ = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZXJ2Y3lkZ2RybGNuZHRqYm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYxNTYsImV4cCI6MjA3MzU1MjE1Nn0.63M53sZW4LEYMOaxScvtLhQr_6VUj7rOaaGtlR745IM";
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Rubik', Arial, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #00C4C7 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 450px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      padding: 40px;
      text-align: center;
    }

    .logo {
      font-size: 64px;
      margin-bottom: 15px;
    }

    .header h1 {
      color: #00C4C7;
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      color: #888;
      font-size: 14px;
    }

    .content {
      padding: 40px;
    }

    .auth-button {
      width: 100%;
      padding: 16px;
      margin-bottom: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .auth-button:hover {
      border-color: #00C4C7;
      background: #f0fdfa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 196, 199, 0.2);
    }

    .auth-button:active {
      transform: translateY(0);
    }

    .auth-button.google {
      color: #1a1a1a;
    }

    .auth-button.metamask {
      background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
      color: white;
      border-color: #f6851b;
    }

    .auth-button.metamask:hover {
      background: linear-gradient(135deg, #e2761b 0%, #cd6116 100%);
      border-color: #e2761b;
    }

    .auth-button.coinbase {
      background: #0052FF;
      color: white;
      border-color: #0052FF;
    }

    .auth-button.coinbase:hover {
      background: #0041CC;
      border-color: #0041CC;
    }

    .auth-button.walletconnect {
      background: #3B99FC;
      color: white;
      border-color: #3B99FC;
    }

    .auth-button.walletconnect:hover {
      background: #2980E3;
      border-color: #2980E3;
    }

    .divider {
      text-align: center;
      margin: 30px 0;
      position: relative;
      color: #9ca3af;
      font-size: 14px;
    }

    .divider::before,
    .divider::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e5e7eb;
    }

    .divider::before { left: 0; }
    .divider::after { right: 0; }

    .footer-note {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: #6b7280;
    }

    .footer-note a {
      color: #00C4C7;
      text-decoration: none;
      font-weight: 600;
    }

    .footer-note a:hover {
      text-decoration: underline;
    }

    .loading {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .icon {
      width: 24px;
      height: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üîê</div>
      <h1 id="pageTitle">Welcome to HRKey</h1>
      <p id="pageSubtitle">Sign in to access your professional profile</p>
    </div>

    <div class="content">
      <!-- Google OAuth -->
      <button class="auth-button google" id="googleBtn">
        <svg class="icon" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>

      <div class="divider">OR CONNECT WALLET</div>

      <!-- MetaMask -->
      <button class="auth-button metamask" id="metamaskBtn">
        ü¶ä Connect with MetaMask
      </button>

      <!-- Coinbase Wallet -->
      <button class="auth-button coinbase" id="coinbaseBtn">
        <svg class="icon" fill="white" viewBox="0 0 48 48">
          <path d="M24 4C12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20S35.046 4 24 4zm0 2c9.941 0 18 8.059 18 18s-8.059 18-18 18S6 33.941 6 24 14.059 6 24 6zm-4 13v10h8V19z"/>
        </svg>
        Coinbase Wallet
      </button>

      <!-- WalletConnect -->
      <button class="auth-button walletconnect" id="walletconnectBtn">
        <svg class="icon" fill="white" viewBox="0 0 300 185">
          <path d="M61.439 36.256c48.91-47.888 128.212-47.888 177.123 0l5.886 5.764c2.446 2.394 2.446 6.277 0 8.671l-20.136 19.716c-1.223 1.197-3.205 1.197-4.428 0l-8.1-7.931c-34.122-33.408-89.444-33.408-123.566 0l-8.675 8.494c-1.223 1.197-3.205 1.197-4.428 0L54.979 51.253c-2.446-2.394-2.446-6.277 0-8.671l6.46-6.326zm218.88 40.794l17.915 17.535c2.446 2.394 2.446 6.277 0 8.671l-80.813 79.138c-2.446 2.394-6.41 2.394-8.856 0l-57.354-56.155c-.611-.598-1.602-.598-2.214 0l-57.354 56.155c-2.446 2.394-6.41 2.394-8.856 0L2.073 103.256c-2.446-2.394-2.446-6.277 0-8.671l17.915-17.535c2.446-2.394 6.41-2.394 8.856 0l57.354 56.155c.611.598 1.603.598 2.214 0l57.354-56.155c2.446-2.395 6.41-2.395 8.856 0l57.354 56.155c.611.598 1.602.598 2.214 0l57.354-56.155c2.446-2.394 6.41-2.394 8.856 0z"/>
        </svg>
        WalletConnect
      </button>

      <div class="footer-note">
        <p>By signing in, you agree to our <a href="#" onclick="alert('Terms of Service'); return false;">Terms of Service</a></p>
        <p style="margin-top: 10px;">
          <a href="/WebDapp/index.html">‚Üê Back to home</a>
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = window.__SUPABASE_URL__;
    const SUPABASE_ANON_KEY = window.__SUPABASE_ANON_KEY__;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Leer par√°metros de URL
    const params = new URLSearchParams(window.location.search);
    const flow = params.get('flow'); // 'signup' o 'signin'
    const plan = params.get('plan'); // 'free' o 'pro' (solo si signup)

    // Actualizar t√≠tulo y subt√≠tulo seg√∫n el flujo
    const pageTitle = document.getElementById('pageTitle');
    const pageSubtitle = document.getElementById('pageSubtitle');

    if (flow === 'signup') {
      if (plan === 'pro') {
        pageTitle.textContent = 'üöÄ Go Pro Today';
        pageSubtitle.textContent = 'Unlock lifetime access for just $9.99';
      } else if (plan === 'free') {
        pageTitle.textContent = 'Get Started for Free';
        pageSubtitle.textContent = 'Create your account and start building your professional profile';
      } else {
        pageTitle.textContent = 'Create Your Account';
        pageSubtitle.textContent = 'Join HRKey and take control of your professional references';
      }
    } else if (flow === 'signin') {
      pageTitle.textContent = 'Welcome Back';
      pageSubtitle.textContent = 'Sign in to access your professional profile';
    }

    // Helper para deshabilitar botones durante carga
    const setLoading = (btn, loading) => {
      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.textContent = '‚è≥ Connecting...';
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
      }
    };

    // Guardar flow y plan en localStorage para usar despu√©s del OAuth callback
    const saveAuthContext = () => {
      if (flow) localStorage.setItem('hrkey_auth_flow', flow);
      if (plan) localStorage.setItem('hrkey_auth_plan', plan);
    };

    // Crear sesi√≥n de checkout de Stripe para el plan Pro
    const createStripeCheckout = async (email) => {
      try {
        const response = await fetch('/api/checkout/session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            plan: 'lifetime',
            email: email,
            success_url: window.location.origin + '/WebDapp/app.html?payment=success',
            cancel_url: window.location.origin + '/WebDapp/auth.html?flow=signup&plan=pro'
          })
        });

        if (!response.ok) {
          throw new Error('Failed to create checkout session');
        }

        const data = await response.json();
        if (data.url) {
          // Redirigir a Stripe Checkout
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        console.error('Stripe checkout error:', error);
        alert('Error creating payment session. Redirecting to dashboard...');
        window.location.replace('/WebDapp/app.html?upgrade_error=true');
      }
    };

    // Verificar si hay un contexto de autenticaci√≥n pendiente y procesarlo
    const processAuthContext = async (session) => {
      const savedFlow = localStorage.getItem('hrkey_auth_flow');
      const savedPlan = localStorage.getItem('hrkey_auth_plan');

      // Limpiar localStorage
      localStorage.removeItem('hrkey_auth_flow');
      localStorage.removeItem('hrkey_auth_plan');

      // Si es signup con plan pro, redirigir a Stripe
      if (savedFlow === 'signup' && savedPlan === 'pro') {
        console.log('Processing Pro plan signup - redirecting to Stripe...');
        const userEmail = session.user?.email || '';
        await createStripeCheckout(userEmail);
        return true;
      }

      // Si es signup con plan free, guardar el plan en el perfil del usuario
      if (savedFlow === 'signup' && savedPlan === 'free') {
        console.log('Processing Free plan signup...');
        // TODO: Guardar plan en la base de datos
        window.location.replace('/WebDapp/app.html?plan=free');
        return true;
      }

      // Para signin normal, simplemente ir al dashboard
      if (savedFlow === 'signin') {
        window.location.replace('/WebDapp/app.html');
        return true;
      }

      return false;
    };

    // Google OAuth
    document.getElementById('googleBtn').addEventListener('click', async () => {
      const btn = document.getElementById('googleBtn');
      setLoading(btn, true);

      // Guardar contexto antes del OAuth
      saveAuthContext();

      try {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + '/WebDapp/app.html'
          }
        });

        if (error) throw error;
      } catch (error) {
        console.error('Google auth error:', error);
        alert('Error connecting with Google. Please try again.');
        setLoading(btn, false);
      }
    });

    // MetaMask
    document.getElementById('metamaskBtn').addEventListener('click', async () => {
      const btn = document.getElementById('metamaskBtn');
      setLoading(btn, true);

      try {
        if (typeof window.ethereum === 'undefined') {
          alert('MetaMask is not installed. Please install MetaMask to continue.');
          setLoading(btn, false);
          return;
        }

        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        if (accounts && accounts[0]) {
          console.log('Connected with MetaMask:', accounts[0]);
          const walletAddress = accounts[0];

          // Guardar wallet address
          localStorage.setItem('hrkey_wallet', walletAddress);

          // Manejar flujos seg√∫n el plan
          if (flow === 'signup' && plan === 'pro') {
            // Para Pro, crear sesi√≥n de Stripe inmediatamente
            await createStripeCheckout(walletAddress);
          } else if (flow === 'signup' && plan === 'free') {
            // Para Free, ir al dashboard
            window.location.href = '/WebDapp/app.html?plan=free&wallet=' + walletAddress;
          } else {
            // Sign in normal
            window.location.href = '/WebDapp/app.html?wallet=' + walletAddress;
          }
        }
      } catch (error) {
        console.error('MetaMask error:', error);
        alert('Error connecting with MetaMask. Please try again.');
        setLoading(btn, false);
      }
    });

    // Coinbase Wallet
    document.getElementById('coinbaseBtn').addEventListener('click', async () => {
      const btn = document.getElementById('coinbaseBtn');
      setLoading(btn, true);

      try {
        // Implementar Coinbase Wallet SDK
        alert('Coinbase Wallet integration coming soon!');
        setLoading(btn, false);
      } catch (error) {
        console.error('Coinbase error:', error);
        alert('Error connecting with Coinbase Wallet. Please try again.');
        setLoading(btn, false);
      }
    });

    // WalletConnect
    document.getElementById('walletconnectBtn').addEventListener('click', async () => {
      const btn = document.getElementById('walletconnectBtn');
      setLoading(btn, true);

      try {
        // Implementar WalletConnect
        alert('WalletConnect integration coming soon!');
        setLoading(btn, false);
      } catch (error) {
        console.error('WalletConnect error:', error);
        alert('Error connecting with WalletConnect. Please try again.');
        setLoading(btn, false);
      }
    });

    // Verificar si ya hay sesi√≥n
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        // Procesar el contexto de autenticaci√≥n si existe
        const handled = await processAuthContext(session);
        if (!handled) {
          // Si no hay contexto guardado, simplemente ir al dashboard
          window.location.replace('/WebDapp/app.html');
        }
      }
    })();
  </script>
</body>
</html>
