<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="author" content="HRKey"/>	
  <meta name="description" content="HRKey Authentication - Secure Login with Web3 & Social Options"/>
  <meta name="keywords" content="HRKey, Authentication, Web3, Wallet, Social Login">	
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>HRKey - Secure Authentication</title>

  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/flaticon.css" rel="stylesheet">
  <link href="css/menu.css" rel="stylesheet">	
  <link href="css/animate.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet"> 
  <link href="css/responsive.css" rel="stylesheet">

  <style>
    .auth-container{min-height:100vh;background:#000;display:flex;align-items:center;justify-content:center;padding:20px}
    .auth-card{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(255,255,255,.1);padding:40px;max-width:480px;width:100%;text-align:center;position:relative}
    .auth-logo{width:200px;height:auto;margin:0 auto 30px;display:block}
    .auth-title{font-size:28px;font-weight:600;color:#1f2937;margin-bottom:10px}
    .auth-subtitle{color:#6b7280;margin-bottom:40px;font-size:16px}
    .auth-method{display:block;width:100%;padding:16px 24px;margin-bottom:16px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;color:#374151;font-weight:500;text-decoration:none;transition:all .3s ease;position:relative;cursor:pointer}
    .auth-method:hover{border-color:#00C4C7;background:#f0fdfa;color:#374151;text-decoration:none;transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,196,199,.15)}
    .auth-method-icon{width:24px;height:24px;margin-right:12px;vertical-align:middle}
    .web3-methods{margin-bottom:30px}
    .social-methods{border-top:1px solid #e5e7eb;padding-top:30px}
    .divider{position:relative;text-align:center;margin:30px 0}
    .divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:#e5e7eb}
    .divider span{background:#fff;color:#9ca3af;padding:0 20px;font-size:14px;position:relative}
    .security-badge{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px;margin-top:30px;font-size:14px;color:#166534}
    .back-link{position:absolute;top:30px;left:30px;color:#fff;text-decoration:none;font-weight:500;transition:opacity .3s ease}
    .back-link:hover{opacity:.8;color:#fff;text-decoration:none}
    .auth-method.primary{background:linear-gradient(135deg,#00C4C7 0%,#00a8aa 100%);color:#fff;border-color:transparent}
    .auth-method.primary:hover{background:linear-gradient(135deg,#00a8aa 0%,#008f91 100%);color:#fff;transform:translateY(-2px)}
    .wallet-status{padding:12px;border-radius:8px;margin-bottom:16px;display:none}
    .wallet-status.success{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534}
    .wallet-status.error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626}
    .wallet-status.loading{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
  </style>
</head>
<body>
  <div class="auth-container">
    <a href="index.html" class="back-link">‚Üê Back to Home</a>

    <div class="auth-card">
      <img src="images/LogoHRKEY-transparente.png" alt="HRKey" class="auth-logo">

      <h1 class="auth-title">Welcome to HRKey</h1>
      <p class="auth-subtitle">Choose your preferred way to access your professional references</p>

      <div id="wallet-status" class="wallet-status"></div>

      <div class="web3-methods">
        <h6 style="color:#6b7280;font-size:14px;font-weight:600;margin-bottom:20px;text-transform:uppercase;letter-spacing:.5px;">Web3 Wallets (Recommended)</h6>
        <a href="#" class="auth-method primary" id="metamask-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="auth-method-icon">
          Connect with MetaMask
        </a>
        <a href="#" class="auth-method" id="coinbase-btn">
          <img src="https://avatars.githubusercontent.com/u/18060234?s=200&v=4" alt="Coinbase Wallet" class="auth-method-icon">
          Connect with Coinbase Wallet
        </a>
      </div>

      <div class="divider"><span>Or continue with</span></div>

      <div class="social-methods">
        <a href="#" class="auth-method" id="google-btn">
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="auth-method-icon">
          Continue with Google
        </a>

        <!-- Dejar ocultos hasta configurar -->
        <a href="#" class="auth-method" id="linkedin-btn" style="display:none;">
          <img src="https://content.linkedin.com/content/dam/me/business/en-us/amp/brand-site/v2/bg/LI-Bug.svg.original.svg" alt="LinkedIn" class="auth-method-icon">
          Continue with LinkedIn
        </a>

        <a href="#" class="auth-method" id="github-btn" style="display:none;">
          <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" class="auth-method-icon">
          Continue with GitHub
        </a>
      </div>

      <div class="security-badge">
        <strong>üîí Secure & Private</strong><br>
        Your data is encrypted and stored on the blockchain. We never store your private keys.
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="js/jquery-3.6.0.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    console.log('üìú HRKey Auth script loading...');

    // ‚ö†Ô∏è Producci√≥n: est√° bien exponer el anon key en el front.
    const SUPABASE_URL = 'https://wrervcydgdrlcndtjboy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZXJ2Y3lkZ2RybGNuZHRqYm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYxNTYsImV4cCI6MjA3MzU1MjE1Nn0.63M53sZW4LEYMOaxScvtLhQr_6VUj7rOaaGtlR745IM';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    class HRKeyAuth {
      constructor() {
        console.log('üöÄ HRKeyAuth initialized');
        this.BACKEND_URL = 'http://localhost:3001';
        this.init();
      }

      async init() {
        console.log('‚öôÔ∏è Setting up event listeners...');
        await this.waitForMetaMask();
        this.setupEventListeners();
        this.checkExistingAuth();
        console.log('‚úÖ HRKeyAuth ready!');
      }

      async waitForMetaMask() {
        console.log('‚è≥ Waiting for wallet providers to initialize...');
        for (let i = 0; i < 10; i++) {
          if (typeof window.ethereum !== 'undefined') {
            console.log('‚úÖ Wallet provider detected!');
            return;
          }
          await new Promise(r => setTimeout(r, 100));
        }
        console.log('‚ö†Ô∏è No wallet provider detected after waiting');
      }

      setupEventListeners() {
        document.getElementById('metamask-btn')?.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ü¶ä MetaMask button clicked');
          this.connectMetaMask();
        });

        document.getElementById('coinbase-btn')?.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('üíô Coinbase Wallet button clicked');
          this.connectCoinbaseWallet();
        });

        document.getElementById('google-btn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          console.log('üîç Google button clicked');
          this.socialLogin('google');
        });

        console.log('‚úÖ All event listeners attached');
      }

      async connectMetaMask() {
        try {
          console.log('üîç Checking for MetaMask...');
          await new Promise(resolve => setTimeout(resolve, 100));

          if (typeof window.ethereum === 'undefined') {
            console.error('‚ùå MetaMask not found');
            this.showWalletStatus('MetaMask not detected. Please install it.', 'error');
            if (confirm('MetaMask not detected. Would you like to install it?')) {
              window.open('https://metamask.io/download/', '_blank');
            }
            return;
          }

          console.log('‚úÖ MetaMask detected!');
          this.showWalletStatus('Connecting to MetaMask...', 'loading');

          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          await this.switchToBaseNetwork();
          const address = accounts[0];
          console.log('üí∞ Connected wallet:', address);

          await this.handleAuthSuccess({ address, authProvider: 'metamask' }, 'wallet');
        } catch (error) {
          console.error('‚ùå MetaMask connection error:', error);
          this.showWalletStatus(`Connection failed: ${error.message}`, 'error');
        }
      }

      async connectCoinbaseWallet() {
        try {
          console.log('üíô Coinbase Wallet clicked');
          await new Promise(resolve => setTimeout(resolve, 100));

          if (typeof window.ethereum === 'undefined') {
            console.error('‚ùå No wallet detected');
            this.showWalletStatus('No wallet detected. Please install Coinbase Wallet.', 'error');
            if (confirm('Coinbase Wallet not detected. Would you like to install it?')) {
              window.open('https://www.coinbase.com/wallet/downloads', '_blank');
            }
            return;
          }

          const isCoinbaseWallet = window.ethereum.isCoinbaseWallet;
          this.showWalletStatus('Connecting to Coinbase Wallet...', 'loading');

          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          await this.switchToBaseNetwork();
          const address = accounts[0];
          console.log('üí∞ Connected wallet:', address);

          await this.handleAuthSuccess({ address, authProvider: isCoinbaseWallet ? 'coinbase' : 'wallet' }, 'wallet');
        } catch (error) {
          console.error('‚ùå Coinbase Wallet connection error:', error);
          this.showWalletStatus(`Connection failed: ${error.message}`, 'error');
        }
      }

      async switchToBaseNetwork() {
        try {
          console.log('üåê Switching to Base network...');
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] });
          console.log('‚úÖ Switched to Base network');
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x2105',
                chainName: 'Base',
                nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                rpcUrls: ['https://mainnet.base.org'],
                blockExplorerUrls: ['https://basescan.org'],
              }],
            });
            console.log('‚úÖ Base network added successfully');
          } else {
            throw switchError;
          }
        }
      }

      async socialLogin(provider) {
        try {
          console.log(`üîê Starting ${provider} social login...`);
          this.showWalletStatus(`Connecting with ${provider.charAt(0).toUpperCase() + provider.slice(1)}...`, 'loading');

          const { data, error } = await supabase.auth.signInWithOAuth({
            provider,
            options: {
              // Despu√©s del callback en Supabase, te devuelve a tu app:
              redirectTo: window.location.origin + '/app.html'
            }
          });

          if (error) throw error;
          // Supabase maneja el redirect autom√°ticamente.
        } catch (error) {
          console.error(`‚ùå ${provider} login error:`, error);
          this.showWalletStatus('Authentication failed. Please try again.', 'error');
        }
      }

      async handleAuthSuccess(authData, authType) {
        console.log(`‚úÖ Auth successful via ${authType}`, authData);

        let walletAddress;

        if (authType === 'wallet') {
          walletAddress = authData.address;
          console.log('üîó Using existing wallet:', walletAddress);

          const userData = {
            address: walletAddress,
            authProvider: authData.authProvider,
            authType: 'wallet',
            hasCustomWallet: false,
            createdAt: Date.now()
          };

          localStorage.setItem('hrkey_wallet', JSON.stringify(userData));
          this.showWalletStatus(`‚úÖ Connected: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`, 'success');

          // Redirigir al dashboard
          setTimeout(() => { window.location.href = 'app.html'; }, 1200);
        }
      }

      async checkExistingAuth() {
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
          console.log('üìù Found active Supabase session:', session.user);
          const existingWallet = localStorage.getItem('hrkey_wallet');

          if (!existingWallet) {
            // Si entr√≥ por social, tu backend podr√≠a crear wallet aqu√≠ (omito llamada por ahora)
            this.showWalletStatus('Signed in with Google. Redirecting...', 'success');
            setTimeout(() => { window.location.href = 'app.html'; }, 800);
          } else {
            const walletData = JSON.parse(existingWallet);
            this.showWalletStatus(`Connected: ${walletData.address.slice(0,6)}...${walletData.address.slice(-4)}`, 'success');
          }
        }

        const existingWallet = localStorage.getItem('hrkey_wallet');
        if (existingWallet) {
          const walletData = JSON.parse(existingWallet);
          console.log('üìù Found existing wallet:', walletData);
          this.showWalletStatus(`Previously connected: ${walletData.address.slice(0,6)}...${walletData.address.slice(-4)}`, 'success');
        }
      }

      showWalletStatus(message, type) {
        console.log(`üì¢ Status: [${type}] ${message}`);
        const statusDiv = document.getElementById('wallet-status');
        if (statusDiv) {
          statusDiv.textContent = message;
          statusDiv.className = `wallet-status ${type}`;
          statusDiv.style.display = 'block';
        }
      }
    }

    // Init
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üé¨ DOM loaded, initializing HRKeyAuth...');
        window.hrKeyAuth = new HRKeyAuth();
      });
    } else {
      console.log('üé¨ DOM already loaded, initializing HRKeyAuth...');
      window.hrKeyAuth = new HRKeyAuth();
    }
  </script>
</body>
</html>
