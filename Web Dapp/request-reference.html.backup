<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="author" content="PeerProof"/>	
    <meta name="description" content="PeerProof - Request Professional Reference"/>
    <meta name="keywords" content="PeerProof, Reference Request, Professional References">	
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Request Reference - PeerProof</title>
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/flaticon.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet"> 
    <link href="css/responsive.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Rubik', sans-serif; }
        .form-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-container { max-width: 800px; margin: 30px auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); overflow: hidden; }
        .form-section { padding: 30px; }
        .section-title { font-size: 24px; font-weight: 600; color: #1f2937; margin-bottom: 10px; }
        .section-subtitle { color: #6b7280; margin-bottom: 30px; font-size: 16px; }
        .form-group { margin-bottom: 25px; }
        .form-label { font-weight: 600; color: #374151; margin-bottom: 8px; display: block; }
        .form-control-custom { border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px 16px; font-size: 16px; transition: all 0.3s ease; width: 100%; }
        .form-control-custom:focus { border-color: #d946ef; box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1); outline: none; }
        .form-control-custom::placeholder { color: #9ca3af; }
        .step-indicator { display: flex; justify-content: center; margin-bottom: 40px; padding: 0 30px; }
        .step { display: flex; align-items: center; position: relative; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px; z-index: 2; position: relative; }
        .step-number.active { background: #d946ef; color: white; }
        .step-number.completed { background: #22c55e; color: white; }
        .step-line { width: 60px; height: 2px; background: #e5e7eb; margin: 0 10px; position: relative; top: 0; align-self: center; }
        .step-line.completed { background: #22c55e; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .btn-primary-custom { background: linear-gradient(135deg, #d946ef 0%, #9333ea 100%); border: none; border-radius: 10px; padding: 12px 30px; font-weight: 600; color: white; transition: all 0.3s ease; }
        .btn-primary-custom:hover { background: linear-gradient(135deg, #c026d3 0%, #7c3aed 100%); transform: translateY(-1px); color: white; }
        .btn-secondary-custom { background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px 30px; font-weight: 600; color: #374151; transition: all 0.3s ease; }
        .btn-secondary-custom:hover { background: #e5e7eb; color: #374151; }
        .form-actions { display: flex; justify-content: space-between; margin-top: 40px; }
        .reference-type-expandable { border: 2px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; overflow: hidden; transition: all 0.3s ease; }
        .reference-type-expandable.expanded { border-color: #d946ef; }
        .reference-type-header { display: flex; align-items: flex-start; padding: 20px; cursor: pointer; position: relative; }
        .reference-type-header input[type="radio"] { margin-right: 15px; margin-top: 5px; accent-color: #d946ef; }
        .reference-header-content { flex: 1; cursor: pointer; }
        .reference-header-content h5 { margin: 0 0 8px 0; font-weight: 600; color: #374151; }
        .reference-header-content p { margin: 0; color: #6b7280; font-size: 16px; }
        .proactive-badge { background: #dcfce7; color: #166534; padding: 8px 12px; border-radius: 6px; margin-top: 10px; font-size: 12px; font-weight: 600; display: inline-block; }
        .expand-icon { width: 30px; height: 30px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #6b7280; transition: all 0.3s ease; margin-left: 15px; }
        .reference-type-expandable.expanded .expand-icon { background: #d946ef; color: white; transform: rotate(45deg); }
        .reference-submenu { display: none; background: #f8fafc; padding: 20px; border-top: 1px solid #e5e7eb; }
        .reference-submenu.show { display: block; }
        .reference-submenu h6 { margin: 0 0 15px 0; color: #374151; font-weight: 600; }
        .submenu-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .submenu-option { display: flex; align-items: center; padding: 12px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .submenu-option:hover { border-color: #d946ef; background: #fdf4ff; }
        .submenu-option input[type="radio"] { margin-right: 10px; accent-color: #d946ef; }
        .submenu-option span { font-weight: 500; color: #374151; }
        .kpi-categories { display: grid; gap: 20px; margin-top: 15px; }
        .kpi-category h6 { color: #374151; font-weight: 600; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #e5e7eb; }
        .kpi-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .kpi-option { display: flex; align-items: center; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
        .kpi-option:hover { border-color: #d946ef; background: #fdf4ff; }
        .kpi-option input[type="checkbox"] { margin-right: 8px; accent-color: #d946ef; }
        .kpi-option input[type="checkbox"]:checked + span { font-weight: 600; color: #7c3aed; }
        .validation-message { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; color: #dc2626; margin-top: 10px; display: none; }
        .back-link { display: inline-flex; align-items: center; color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s ease; }
        .back-link:hover { opacity: 0.8; color: white; text-decoration: none; }
        .form-help-text { font-size: 14px; color: #6b7280; margin-top: 5px; }
        .character-counter { text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px; }
        .preview-section { background: #f8fafc; border-radius: 12px; padding: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .submenu-options { grid-template-columns: 1fr; } }
    </style>
    <script src="js/api-client.js"></script>
    <script src="js/form-enhancements.js"></script>
</head>
<body>
    <header class="form-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="app.html" class="back-link">← Back to Dashboard</a>
                <h4 style="margin: 0; font-weight: 600;">Request Professional Reference</h4>
                <div style="width: 150px;"></div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="form-container">
                <div class="step-indicator" style="padding: 30px 30px 20px 30px;">
                    <div class="step"><div class="step-number active" id="step-1-indicator">1</div><span>Reference Type</span></div>
                    <div class="step-line" id="line-1"></div>
                    <div class="step"><div class="step-number" id="step-5-indicator">2</div><span>Your Context</span></div><div class="step-line"></div><div class="step"><div class="step-number" id="step-5-indicator">5</div><span>Your Context</span></div>
                    <div class="step-line" id="line-2"></div>
                    <div class="step"><div class="step-number" id="step-5-indicator">3</div><span>KPIs & Objectives</span></div>
                    <div class="step-line" id="line-3"></div>
                    <div class="step"><div class="step-number" id="step-5-indicator">4</div><span>Additional Context</span></div>
                    <div class="step-line" id="line-4"></div>
                    <div class="step"><div class="step-number" id="step-5-indicator">5</div><span>Review & Send</span></div>
                </div>
                <div class="step-content active" id="step-1">
                    <div class="form-section">
                        <h3 class="section-title">What type of reference do you need?</h3>
                        <p class="section-subtitle">Choose the timing that best fits your situation.</p>
                        <div class="reference-timing">
                            <div class="reference-type-expandable" data-type="proactive">
                                <div class="reference-type-header">
                                    <input type="radio" name="referenceTiming" value="proactive" id="proactive-radio">
                                    <label for="proactive-radio" class="reference-header-content">
                                        <h5>Proactive Reference</h5>
                                        <p>Start building your reference now with clear KPIs and objectives for ongoing or upcoming work.</p>
                                        <div class="proactive-badge">Higher credibility • More objective • Better outcomes</div>
                                    </label>
                                    <div class="expand-icon">+</div>
                                </div>
                                <div class="reference-submenu" id="proactive-submenu">
                                    <h6>Select your working relationship:</h6>
                                    <div class="submenu-options">
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="supervisor"><span>Supervisor/Manager</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="peer"><span>Peer/Colleague</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="client"><span>Client/Customer</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="subordinate"><span>Team Member</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="reference-type-expandable" data-type="retroactive">
                                <div class="reference-type-header">
                                    <input type="radio" name="referenceTiming" value="retroactive" id="retroactive-radio">
                                    <label for="retroactive-radio" class="reference-header-content">
                                        <h5>Retroactive Reference</h5>
                                        <p>Request a reference for past work relationships where collaboration has already ended.</p>
                                    </label>
                                    <div class="expand-icon">+</div>
                                </div>
                                <div class="reference-submenu" id="retroactive-submenu">
                                    <h6>Select your working relationship:</h6>
                                    <div class="submenu-options">
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="supervisor"><span>Supervisor/Manager</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="peer"><span>Peer/Colleague</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="client"><span>Client/Customer</span></label>
                                        <label class="submenu-option"><input type="radio" name="relationshipType" value="subordinate"><span>Team Member</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <div></div>
                            <button class="btn btn-primary-custom" onclick="nextStep()" id="step1-next" disabled>Next Step</button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step-1-5">
                    <div class="form-section">
                        <h3 class="section-title">Your Professional Context</h3>
                        <p class="section-subtitle">Help us understand your role to suggest relevant KPIs.</p>
                        <div class="form-group">
                            <label class="form-label">Your Position *</label>
                            <select class="form-control-custom" id="applicantPosition" required>
                                <option value="">Select your role...</option>
                                <option value="software-engineer">Software Engineer</option>
                                <option value="product-manager">Product Manager</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary-custom" onclick="prevStep()">Previous</button>
                            <button class="btn btn-primary-custom" onclick="nextStep()">Continue</button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step-5">
                    <div class="form-section">
                        <h3 class="section-title">Referee Information</h3>
                        <p class="section-subtitle">Provide details about the person you're requesting a reference from.</p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">First Name *</label>
                                    <input type="text" class="form-control-custom" id="refereeFirstName" placeholder="Enter first name" required>
                                    <div class="validation-message" id="firstNameError">First name is required</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Last Name *</label>
                                    <input type="text" class="form-control-custom" id="refereeLastName" placeholder="Enter last name" required>
                                    <div class="validation-message" id="lastNameError">Last name is required</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control-custom" id="refereeEmail" placeholder="referee@company.com" required>
                            <div class="validation-message" id="emailError">Valid email address is required</div>
                            <div class="form-help-text">We'll send a secure invitation to this email address</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Job Title *</label>
                                    <input type="text" class="form-control-custom" id="refereeJobTitle" placeholder="Senior Manager, Director, etc." required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Company *</label>
                                    <input type="text" class="form-control-custom" id="refereeCompany" placeholder="Company name" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">LinkedIn Profile (Optional)</label>
                            <input type="url" class="form-control-custom" id="refereeLinkedIn" placeholder="https://linkedin.com/in/...">
                            <div class="form-help-text">This helps verify their professional identity</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary-custom" onclick="prevStep()">Previous</button>
                            <button class="btn btn-primary-custom" onclick="nextStep()">Next Step</button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step-5">
                    <div class="form-section">
                        <h3 class="section-title">Define Success Metrics & KPIs</h3>
                        <p class="section-subtitle">Set clear, measurable objectives that will be evaluated. This creates the most objective reference possible.</p>
                        <div class="kpi-notice" style="background: #e0e7ff; border: 1px solid #c7d2fe; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                            <h5 style="color: #3730a3; margin-bottom: 10px;">💡 Why define KPIs upfront?</h5>
                            <ul style="color: #1e1b4b; margin: 0; font-size: 14px;">
                                <li>Creates objective, measurable evaluation criteria</li>
                                <li>Eliminates subjective bias and memory distortion</li>
                                <li>Higher credibility with future employers</li>
                                <li>Clear expectations for both parties</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project/Role Duration *</label>
                            <select class="form-control-custom" id="projectDuration" required>
                                <option value="">Select expected duration</option>
                                <option value="1-3months">1-3 months</option>
                                <option value="3-6months">3-6 months</option>
                                <option value="6-12months">6-12 months</option>
                                <option value="1-2years">1-2 years</option>
                                <option value="2+years">2+ years</option>
                                <option value="ongoing">Ongoing collaboration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Success Metrics (Choose up to 5) *</label>
                            <p class="form-help-text">Select the key performance indicators that will be measured</p>
                            <div class="kpi-categories">
                                <div class="kpi-category">
                                    <h6>📊 Quantitative Metrics</h6>
                                    <div class="kpi-options">
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="revenue-growth"><span>Revenue/Sales Growth (%)</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="project-delivery"><span>Project Delivery Timeline</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="cost-efficiency"><span>Cost Efficiency/Budget Management</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="quality-metrics"><span>Quality Metrics (Error rates, etc.)</span></label>
                                    </div>
                                </div>
                                <div class="kpi-category">
                                    <h6>🎯 Performance Metrics</h6>
                                    <div class="kpi-options">
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="goal-achievement"><span>Goal Achievement Rate</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="productivity"><span>Productivity/Output Metrics</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="innovation"><span>Innovation/Process Improvements</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="customer-satisfaction"><span>Customer/Stakeholder Satisfaction</span></label>
                                    </div>
                                </div>
                                <div class="kpi-category">
                                    <h6>👥 Collaboration Metrics</h6>
                                    <div class="kpi-options">
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="team-leadership"><span>Team Leadership Effectiveness</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="communication"><span>Communication Effectiveness</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="mentorship"><span>Mentorship/Knowledge Transfer</span></label>
                                        <label class="kpi-option"><input type="checkbox" name="kpis" value="collaboration"><span>Cross-team Collaboration</span></label>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right; margin-top: 10px; font-size: 14px; color: #6b7280;"><span id="kpi-count">0</span>/5 metrics selected</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specific Success Targets *</label>
                            <textarea class="form-control-custom" id="successTargets" rows="4" placeholder="Define specific, measurable targets for each selected KPI. Example: 'Increase team productivity by 25%', 'Deliver project 2 weeks ahead of schedule', 'Achieve 95% client satisfaction score'..." maxlength="500" required></textarea>
                            <div class="character-counter"><span id="targetsCounter">0</span>/500 characters</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Evaluation Method *</label>
                            <select class="form-control-custom" id="evaluationMethod" required>
                                <option value="">How will success be measured?</option>
                                <option value="milestone-based">Milestone-based reviews</option>
                                <option value="monthly-reviews">Monthly performance reviews</option>
                                <option value="project-completion">At project completion</option>
                                <option value="quarterly-reviews">Quarterly assessments</option>
                                <option value="continuous-tracking">Continuous tracking with dashboards</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary-custom" onclick="prevStep()">Previous</button>
                            <button class="btn btn-primary-custom" onclick="nextStep()">Continue to Additional Context</button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step-5">
                    <div class="form-section">
                        <h3 class="section-title">Additional Context</h3>
                        <p class="section-subtitle">Provide any additional details that would help the referee write a comprehensive reference.</p>
                        <div class="form-group">
                            <label class="form-label">Context for Referee (Optional)</label>
                            <textarea class="form-control-custom" id="additionalContext" rows="6" placeholder="Remind them about specific projects or achievements you'd like them to highlight in their reference. Example: Led the Q4 product launch that exceeded targets by 25%, managed team of 5 developers during system migration..." maxlength="500"></textarea>
                            <div class="character-counter"><span id="contextCounter">0</span>/500 characters</div>
                            <div class="form-help-text">This information helps the referee provide specific examples and context in their evaluation</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary-custom" onclick="prevStep()">Previous</button>
                            <button class="btn btn-primary-custom" onclick="nextStep()">Review & Send</button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step-5">
                    <div class="form-section">
                        <h3 class="section-title">Review Your Request</h3>
                        <p class="section-subtitle">Please review all details before sending your reference request.</p>
                        <div class="preview-section">
                            <h5>Reference Request Summary</h5>
                            <div id="reviewContent"></div>
                        </div>
                        <div class="form-group" style="margin-top: 30px;">
                            <label class="form-label">
                                <input type="checkbox" id="termsAccept" style="margin-right: 10px;">
                                I confirm that the information provided is accurate and I have permission to request a reference from this person.
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary-custom" onclick="prevStep()">Previous</button>
                            <button class="btn btn-primary-custom" onclick="submitRequest()" id="submitBtn" disabled>Send Reference Request</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        class ReferenceRequestForm {
            constructor() { this.currentStep = 1; this.formData = {}; this.selectedSkills = []; this.init(); }
            init() { this.setupEventListeners(); this.updateCharacterCounters(); this.setupKPITracking(); }
            setupEventListeners() {
                document.querySelectorAll('.reference-type-expandable .reference-type-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (!e.target.matches('input[type="radio"]') && !e.target.closest('label')) {
                            this.toggleReferenceSubmenu(header.closest('.reference-type-expandable'));
                        }
                    });
                });
                document.querySelectorAll('input[name="referenceTiming"]').forEach(radio => {
                    radio.addEventListener('change', (e) => { this.handleReferenceTimingChange(e.target); });
                });
                document.querySelectorAll('input[name="relationshipType"]').forEach(radio => {
                    radio.addEventListener('change', (e) => { this.enableNextStep(); });
                });
                document.getElementById('additionalContext').addEventListener('input', () => {
                    this.updateCharacterCounter('additionalContext', 'contextCounter', 500);
                });
                document.getElementById('successTargets').addEventListener('input', () => {
                    this.updateCharacterCounter('successTargets', 'targetsCounter', 500);
                });
                document.getElementById('termsAccept').addEventListener('change', (e) => {
                    document.getElementById('submitBtn').disabled = !e.target.checked;
                });
                this.setupValidation();
            }
            toggleReferenceSubmenu(expandableElement) {
                const submenu = expandableElement.querySelector('.reference-submenu');
                const icon = expandableElement.querySelector('.expand-icon');
                document.querySelectorAll('.reference-type-expandable').forEach(el => {
                    if (el !== expandableElement) {
                        el.classList.remove('expanded');
                        el.querySelector('.reference-submenu').classList.remove('show');
                        el.querySelector('.expand-icon').textContent = '+';
                    }
                });
                submenu.classList.toggle('show');
                expandableElement.classList.toggle('expanded');
                if (expandableElement.classList.contains('expanded')) { icon.textContent = '×'; } else { icon.textContent = '+'; }
            }
            handleReferenceTimingChange(radioElement) {
                const expandableElement = radioElement.closest('.reference-type-expandable');
                if (!expandableElement.classList.contains('expanded')) { this.toggleReferenceSubmenu(expandableElement); }
                document.querySelectorAll('input[name="relationshipType"]').forEach(radio => { radio.checked = false; });
                document.getElementById('step1-next').disabled = true;
            }
            enableNextStep() {
                const referenceTiming = document.querySelector('input[name="referenceTiming"]:checked');
                const relationshipType = document.querySelector('input[name="relationshipType"]:checked');
                if (referenceTiming && relationshipType) { document.getElementById('step1-next').disabled = false; }
            }
            setupKPITracking() {
                const kpiCheckboxes = document.querySelectorAll('input[name="kpis"]');
                kpiCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => { this.updateKPICounter(); });
                });
            }
            updateKPICounter() {
                const selectedKPIs = document.querySelectorAll('input[name="kpis"]:checked');
                const counter = document.getElementById('kpi-count');
                counter.textContent = selectedKPIs.length;
                if (selectedKPIs.length >= 5) {
                    document.querySelectorAll('input[name="kpis"]:not(:checked)').forEach(cb => { cb.disabled = true; });
                } else {
                    document.querySelectorAll('input[name="kpis"]').forEach(cb => { cb.disabled = false; });
                }
            }
            setupValidation() {
                const inputs = document.querySelectorAll('.form-control-custom[required]');
                inputs.forEach(input => { input.addEventListener('blur', () => { this.validateField(input); }); });
            }
            validateField(field) {
                const value = field.value.trim(); const fieldName = field.id; let isValid = true; let errorMessage = '';
                if (field.hasAttribute('required') && !value) { isValid = false; errorMessage = 'This field is required'; } 
                else if (field.type === 'email' && value && !this.isValidEmail(value)) { isValid = false; errorMessage = 'Please enter a valid email address'; }
                this.showValidationMessage(fieldName, errorMessage, !isValid); return isValid;
            }
            isValidEmail(email) { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(email); }
            showValidationMessage(fieldName, message, show) {
                const errorElement = document.getElementById(fieldName + 'Error') || document.querySelector(`#${fieldName} + .validation-message`);
                if (errorElement) { errorElement.textContent = message; errorElement.style.display = show ? 'block' : 'none'; }
            }
            updateCharacterCounter(inputId, counterId, maxLength) {
                const input = document.getElementById(inputId); const counter = document.getElementById(counterId);
                const currentLength = input.value.length; counter.textContent = currentLength;
                if (currentLength > maxLength * 0.9) { counter.style.color = '#dc2626'; } else { counter.style.color = '#6b7280'; }
            }
            updateCharacterCounters() {
                this.updateCharacterCounter('additionalContext', 'contextCounter', 500);
                this.updateCharacterCounter('successTargets', 'targetsCounter', 500);
            }
            nextStep() {
                if (this.validateCurrentStep()) {
                    this.saveStepData(); this.currentStep++; this.showStep(this.currentStep); this.updateStepIndicator();
                    if (this.currentStep === 5) { this.populateReview(); }
                }
            }
            prevStep() { this.currentStep--; this.showStep(this.currentStep); this.updateStepIndicator(); }
            showStep(stepNumber) {
                document.querySelectorAll('.step-content').forEach(step => { step.classList.remove('active'); });
                document.getElementById(`step-${stepNumber}`).classList.add('active');
            }
            updateStepIndicator() {
                for (let i = 1; i <= 5; i++) {
                    const indicator = document.getElementById(`step-${i}-indicator`); const line = document.getElementById(`line-${i}`);
                    if (i < this.currentStep) { indicator.classList.add('completed'); indicator.classList.remove('active'); if (line) line.classList.add('completed'); } 
                    else if (i === this.currentStep) { indicator.classList.add('active'); indicator.classList.remove('completed'); } 
                    else { indicator.classList.remove('active', 'completed'); if (line) line.classList.remove('completed'); }
                }
            }
            validateCurrentStep() {
                switch (this.currentStep) {
                    case 1:
                        const referenceTiming = document.querySelector('input[name="referenceTiming"]:checked');
                        const relationshipType = document.querySelector('input[name="relationshipType"]:checked');
                        if (!referenceTiming) { alert('Please select a reference timing (Proactive or Retroactive)'); return false; }
                        if (!relationshipType) { alert('Please select your working relationship type'); return false; }
                        return true;
                    case 2:
                        const requiredFields = ['refereeFirstName', 'refereeLastName', 'refereeEmail', 'refereeJobTitle', 'refereeCompany'];
                        let allValid = true;
                        requiredFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (!this.validateField(field)) { allValid = false; }
                        });
                        return allValid;
                    case 3:
                        const selectedKPIs = document.querySelectorAll('input[name="kpis"]:checked');
                        if (selectedKPIs.length === 0) { alert('Please select at least one KPI metric'); return false; }
                        const requiredStep3 = ['projectDuration', 'successTargets', 'evaluationMethod'];
                        let step3Valid = true;
                        requiredStep3.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (!this.validateField(field)) { step3Valid = false; }
                        });
                        return step3Valid;
                    case 4: return true;
                    default: return true;
                }
            }
            saveStepData() {
                switch (this.currentStep) {
                    case 1:
                        this.formData.referenceTiming = document.querySelector('input[name="referenceTiming"]:checked').value;
                        this.formData.relationshipType = document.querySelector('input[name="relationshipType"]:checked').value;
                        break;
                    case 2:
                        this.formData.referee = {
                            firstName: document.getElementById('refereeFirstName').value,
                            lastName: document.getElementById('refereeLastName').value,
                            email: document.getElementById('refereeEmail').value,
                            jobTitle: document.getElementById('refereeJobTitle').value,
                            company: document.getElementById('refereeCompany').value,
                            linkedIn: document.getElementById('refereeLinkedIn').value
                        };
                        break;
                    case 3:
                        const selectedKPIs = Array.from(document.querySelectorAll('input[name="kpis"]:checked')).map(cb => cb.value);
                        this.formData.kpis = {
                            projectDuration: document.getElementById('projectDuration').value,
                            selectedKPIs: selectedKPIs,
                            successTargets: document.getElementById('successTargets').value,
                            evaluationMethod: document.getElementById('evaluationMethod').value
                        };
                        break;
                    case 4:
                        this.formData.additionalContext = document.getElementById('additionalContext').value;
                        break;
                }
            }
            populateReview() {
                const reviewContent = document.getElementById('reviewContent');
                const referee = this.formData.referee; const kpis = this.formData.kpis;
                reviewContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Reference Type:</h6>
                            <p>${this.getReferenceTypeLabel(this.formData.referenceTiming)} - ${this.getRelationshipLabel(this.formData.relationshipType)}</p>
                            <h6>Referee:</h6>
                            <p>${referee.firstName} ${referee.lastName}<br>${referee.jobTitle} at ${referee.company}<br>${referee.email}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Project Duration:</h6>
                            <p>${this.getProjectDurationLabel(kpis.projectDuration)}</p>
                            <h6>Evaluation Method:</h6>
                            <p>${this.getEvaluationMethodLabel(kpis.evaluationMethod)}</p>
                        </div>
                    </div>
                    ${kpis.selectedKPIs.length > 0 ? `<h6>Selected KPIs:</h6><p>${kpis.selectedKPIs.map(kpi => this.getKPILabel(kpi)).join(', ')}</p>` : ''}
                    ${kpis.successTargets ? `<h6>Success Targets:</h6><p>${kpis.successTargets}</p>` : ''}
                    ${this.formData.additionalContext ? `<h6>Additional Context:</h6><p>${this.formData.additionalContext}</p>` : ''}
                `;
            }
            getReferenceTypeLabel(type) { const labels = {'proactive': 'Proactive Reference', 'retroactive': 'Retroactive Reference'}; return labels[type] || type; }
            getRelationshipLabel(type) { const labels = {'supervisor': 'Supervisor/Manager', 'peer': 'Peer/Colleague', 'client': 'Client/Customer', 'subordinate': 'Team Member'}; return labels[type] || type; }
            getProjectDurationLabel(duration) { const labels = {'1-3months': '1-3 months', '3-6months': '3-6 months', '6-12months': '6-12 months', '1-2years': '1-2 years', '2+years': '2+ years', 'ongoing': 'Ongoing collaboration'}; return labels[duration] || duration; }
            getEvaluationMethodLabel(method) { const labels = {'milestone-based': 'Milestone-based reviews', 'monthly-reviews': 'Monthly performance reviews', 'project-completion': 'At project completion', 'quarterly-reviews': 'Quarterly assessments', 'continuous-tracking': 'Continuous tracking with dashboards'}; return labels[method] || method; }
            getKPILabel(kpi) { const labels = {'revenue-growth': 'Revenue/Sales Growth', 'project-delivery': 'Project Delivery Timeline', 'cost-efficiency': 'Cost Efficiency/Budget Management', 'quality-metrics': 'Quality Metrics', 'goal-achievement': 'Goal Achievement Rate', 'productivity': 'Productivity/Output Metrics', 'innovation': 'Innovation/Process Improvements', 'customer-satisfaction': 'Customer/Stakeholder Satisfaction', 'team-leadership': 'Team Leadership Effectiveness', 'communication': 'Communication Effectiveness', 'mentorship': 'Mentorship/Knowledge Transfer', 'collaboration': 'Cross-team Collaboration'}; return labels[kpi] || kpi; }
            async submitRequest() {
                try {
                    this.saveStepData();
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.textContent = 'Sending Request...'; submitBtn.disabled = true;
                    const requestData = { id: Date.now(), ...this.formData, status: 'pending', createdAt: new Date().toISOString(), requesterAddress: this.getCurrentUserAddress() };
                    console.log('Submitting reference request:', requestData);
                    await this.saveToLocalStorage(requestData);
                    await this.sendToBlockchain(requestData);
                    await this.notifyReferee(requestData);
                    this.showSuccessMessage();
                } catch (error) {
                    console.error('Error submitting request:', error);
                    alert('There was an error sending your request. Please try again.');
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.textContent = 'Send Reference Request'; submitBtn.disabled = false;
                }
            }
            async saveToLocalStorage(requestData) {
                let existingRequests = JSON.parse(localStorage.getItem('peerproof_requests') || '[]');
                existingRequests.push(requestData);
                localStorage.setItem('peerproof_requests', JSON.stringify(existingRequests));
                this.updateUserStats();
            }
            updateUserStats() {
                let stats = JSON.parse(localStorage.getItem('peerproof_stats') || '{"totalReferences": 0, "verifiedReferences": 0, "pendingValidations": 0, "profileViews": 145}');
                stats.totalReferences++; stats.pendingValidations++;
                localStorage.setItem('peerproof_stats', JSON.stringify(stats));
            }
            getCurrentUserAddress() {
                const authData = localStorage.getItem('peerproof_auth');
                if (authData) { const parsed = JSON.parse(authData); return parsed.address; }
                return null;
            }
            async sendToBlockchain(data) { return new Promise((resolve) => { setTimeout(() => { console.log('Reference request stored on blockchain'); resolve(); }, 2000); }); }
            async notifyReferee(data) { return new Promise((resolve) => { setTimeout(() => { console.log('Email notification sent to referee'); resolve(); }, 1000); }); }
            showSuccessMessage() {
                const container = document.querySelector('.form-container');
                container.innerHTML = `
                    <div class="form-section text-center" style="padding: 60px 30px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">✅</div>
                        <h3 class="section-title">Reference Request Sent!</h3>
                        <p class="section-subtitle">Your reference request has been successfully sent to ${this.formData.referee.firstName} ${this.formData.referee.lastName}.</p>
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 30px 0; text-align: left;">
                            <h5>What happens next?</h5>
                            <ul style="color: #6b7280; margin: 0;">
                                <li>The referee will receive a secure email invitation</li>
                                <li>They can fill out the reference form at their convenience</li>
                                <li>Once completed, the reference will be verified on the blockchain</li>
                                <li>You'll receive a notification when it's ready</li>
                            </ul>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                            <a href="app.html?updated=true" class="btn btn-primary-custom">Back to Dashboard</a>
                            <button class="btn btn-secondary-custom" onclick="location.reload()">Send Another Request</button>
                        </div>
                    </div>
                `;
                setTimeout(() => { window.location.href = 'app.html?updated=true'; }, 3000);
            }
        }
        function nextStep() { if (window.referenceForm) { window.referenceForm.nextStep(); } }
        function prevStep() { if (window.referenceForm) { window.referenceForm.prevStep(); } }
        function submitRequest() { if (window.referenceForm) { window.referenceForm.submitRequest(); } }
        document.addEventListener('DOMContentLoaded', () => { window.referenceForm = new ReferenceRequestForm(); });
    </script>
</body>
</html>
