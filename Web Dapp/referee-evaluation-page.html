<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Reference - HRKey</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:800px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.2em;margin-bottom:10px;font-weight:600}
    .header p{font-size:1.1em;opacity:.9}
    .content{padding:40px}
    .request-summary{background:#f8fafc;border-radius:15px;padding:25px;margin-bottom:30px;border:1px solid #e2e8f0}
    .request-summary h3{color:#1e293b;margin-bottom:20px;font-size:1.3em;display:flex;align-items:center;gap:10px}
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
    .summary-item{background:#fff;padding:15px;border-radius:10px;border:1px solid #e2e8f0}
    .summary-item label{font-size:.9em;color:#64748b;font-weight:500;margin-bottom:5px;display:block}
    .summary-item .value{color:#1e293b;font-weight:600}
    .evaluation-form{margin-bottom:30px}
    .section{margin-bottom:35px}
    .section-title{font-size:1.3em;color:#1e293b;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #e2e8f0;display:flex;align-items:center;gap:10px}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .kpi-item{background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0}
    .kpi-item h4{color:#1e293b;margin-bottom:8px;font-size:1.1em}
    .kpi-item .description{color:#64748b;font-size:.9em;margin-bottom:15px}
    .rating-section{display:flex;align-items:center;gap:15px;margin-bottom:15px}
    .rating-section label{font-weight:500;color:#374151;min-width:80px}
    .star-rating{display:flex;gap:5px}
    .star{font-size:1.5em;color:#d1d5db;cursor:pointer;transition:all .2s ease}
    .star:hover,.star.active{color:#f59e0b;transform:scale(1.1)}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#374151}
    .form-group textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:1em;resize:vertical;min-height:100px;transition:border-color .3s ease}
    .form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .blockchain-info{background:linear-gradient(135deg,#ede9fe 0%,#f3e8ff 100%);border:1px solid #c4b5fd;border-radius:15px;padding:25px;margin-bottom:30px}
    .info-header{display:flex;align-items:center;gap:12px;margin-bottom:15px}
    .info-header .icon{font-size:1.5em}
    .info-header h4{color:#5b21b6;font-size:1.2em}
    .blockchain-features{list-style:none;padding:0}
    .blockchain-features li{color:#6b21a8;margin-bottom:8px;padding-left:20px;position:relative}
    .blockchain-features li:before{content:"✓";position:absolute;left:0;color:#7c3aed;font-weight:bold}
    .rectification-note{color:#059669;font-style:italic;font-size:.95em;background:rgba(16,185,129,.1);padding:8px 12px;border-radius:6px;border-left:3px solid #10b981;margin-top:8px}
    .submit-section{text-align:center;margin-top:40px}
    .submit-btn{background:linear-gradient(135deg,#c084fc 0%,#a855f7 100%);color:#fff;border:none;padding:15px 40px;font-size:1.1em;font-weight:600;border-radius:50px;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 15px rgba(168,85,247,.3)}
    .submit-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(168,85,247,.4)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .confirmation-text{color:#6b7280;font-size:.9em;margin-top:15px;font-style:italic}
    .progress-indicator{background:#f1f5f9;border-radius:10px;padding:15px;margin-bottom:30px;border-left:4px solid #667eea}
    .progress-indicator h4{color:#1e293b;margin-bottom:5px}
    .progress-indicator p{color:#64748b;font-size:.9em}
    .gasless-quota{background:#fef3c7;border:1px solid #fbbf24;border-radius:10px;padding:15px;margin-bottom:20px}
    .gasless-quota h4{color:#92400e;margin-bottom:8px}
    .gasless-quota p{color:#78350f;font-size:.9em}
    .warning-message{background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:15px;margin-bottom:20px}
    .warning-message h4{color:#991b1b;margin-bottom:8px}
    .warning-message p{color:#7f1d1d;font-size:.9em}
    @media (max-width:768px){
      .container{margin:10px;border-radius:15px}
      .header{padding:20px}
      .header h1{font-size:1.8em}
      .content{padding:25px}
      .summary-grid,.kpi-grid{grid-template-columns:1fr}
      .rating-section{flex-direction:column;align-items:flex-start;gap:10px}
    }
    .success-message{display:none;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border:1px solid #6ee7b7;border-radius:15px;padding:25px;text-align:center;margin-top:20px}
    .success-message h3{color:#065f46;margin-bottom:10px}
    .success-message p{color:#047857}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Complete Professional Reference</h1>
      <p>Your evaluation will help build a verified professional profile</p>
    </div>

    <div class="content">
      <div class="progress-indicator">
        <h4>Reference Request</h4>
        <p>You've been invited to provide a professional reference. Please complete all sections below.</p>
      </div>

      <!-- Quota indicator (se llena con JS) -->
      <div id="quotaIndicator" style="display:none;"></div>

      <div class="request-summary">
        <h3>Request Summary</h3>
        <div class="summary-grid">
          <div class="summary-item"><label>Applicant</label><div class="value">Sarah Johnson</div></div>
          <div class="summary-item"><label>Position During Collaboration</label><div class="value">Senior Product Manager</div></div>
          <div class="summary-item"><label>Collaboration Period</label><div class="value">Jan 2023 - Dec 2023</div></div>
          <div class="summary-item"><label>Reference Type</label><div class="value">Proactive Reference</div></div>
          <div class="summary-item"><label>Project Duration</label><div class="value">12 months</div></div>
          <div class="summary-item"><label>Your Role</label><div class="value">Direct Supervisor</div></div>
        </div>
      </div>

      <form class="evaluation-form" id="referenceForm">
        <div class="section">
          <h3 class="section-title">KPI Evaluation</h3>
          <p style="color:#64748b;margin-bottom:25px;">Rate the applicant's performance on the predefined objectives:</p>

          <div class="kpi-grid">
            <div class="kpi-item">
              <h4>Product Launch Success</h4>
              <p class="description">Successfully launch 2 major product features within Q4 timeline</p>
              <div class="rating-section">
                <label>Rating:</label>
                <div class="star-rating" data-kpi="launch">
                  <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                </div>
              </div>
              <div class="form-group">
                <label>Comments on this KPI:</label>
                <textarea name="launch_comments" placeholder="Provide specific examples and context..."></textarea>
              </div>
            </div>

            <div class="kpi-item">
              <h4>Team Leadership</h4>
              <p class="description">Lead cross-functional team of 8+ members effectively</p>
              <div class="rating-section">
                <label>Rating:</label>
                <div class="star-rating" data-kpi="leadership">
                  <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                </div>
              </div>
              <div class="form-group">
                <label>Comments on this KPI:</label>
                <textarea name="leadership_comments" placeholder="Describe leadership style and effectiveness..."></textarea>
              </div>
            </div>

            <div class="kpi-item">
              <h4>Stakeholder Satisfaction</h4>
              <p class="description">Maintain 90%+ satisfaction rate from key stakeholders</p>
              <div class="rating-section">
                <label>Rating:</label>
                <div class="star-rating" data-kpi="satisfaction">
                  <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                </div>
              </div>
              <div class="form-group">
                <label>Comments on this KPI:</label>
                <textarea name="satisfaction_comments" placeholder="Share feedback from stakeholders..."></textarea>
              </div>
            </div>

            <div class="kpi-item">
              <h4>Innovation & Problem Solving</h4>
              <p class="description">Identify and implement 3+ process improvements</p>
              <div class="rating-section">
                <label>Rating:</label>
                <div class="star-rating" data-kpi="innovation">
                  <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                </div>
              </div>
              <div class="form-group">
                <label>Comments on this KPI:</label>
                <textarea name="innovation_comments" placeholder="Detail innovations and improvements made..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">Professional Skills Assessment</h3>
          <div class="form-group">
            <label>Technical Competencies</label>
            <textarea name="technical" placeholder="Evaluate technical skills relevant to their role..."></textarea>
          </div>
          <div class="form-group">
            <label>Communication & Collaboration</label>
            <textarea name="communication" placeholder="Assess communication style and teamwork abilities..."></textarea>
          </div>
          <div class="form-group">
            <label>Reliability & Work Quality</label>
            <textarea name="reliability" placeholder="Comment on consistency, attention to detail, and delivery quality..."></textarea>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">Overall Recommendation</h3>
          <div class="form-group">
            <label>Would you recommend this person for similar roles? Why?</label>
            <textarea name="recommendation" placeholder="Provide your overall recommendation and reasoning..."></textarea>
          </div>
          <div class="form-group">
            <label>Strengths & Areas for Growth</label>
            <textarea name="strengths" placeholder="Highlight key strengths and any development areas..."></textarea>
          </div>
          <div class="form-group">
            <label>Additional Context</label>
            <textarea name="additional" placeholder="Any other relevant information for future employers..."></textarea>
          </div>
        </div>

        <div class="blockchain-info">
          <div class="info-header"><i class="icon">🔐</i><h4>Blockchain Verification</h4></div>
          <ul class="blockchain-features">
            <li>This reference will be cryptographically signed and stored on the blockchain</li>
            <li>Your evaluation becomes an immutable, verifiable record</li>
            <li>Only you can provide this reference for the specified individual and criteria</li>
            <li>The original reference cannot be altered once submitted</li>
            <li class="rectification-note">However, it can be partially/fully suppressed or rectified with additional context from the applicant and other referees they invite</li>
          </ul>
        </div>

        <div class="submit-section">
          <button type="submit" class="submit-btn" id="submitBtn">
            Complete & Submit Reference
          </button>
          <p class="confirmation-text">
            By submitting, you confirm this evaluation is accurate and complete
          </p>
        </div>

        <div class="success-message" id="successMessage">
          <h3>Reference Successfully Submitted!</h3>
          <p>Your professional reference has been recorded on the blockchain and the applicant has been notified.</p>
          <div style="margin-top:15px;padding:15px;background:rgba(6,95,70,.1);border-radius:8px;border-left:3px solid #10b981;">
            <h4 style="color:#065f46;margin-bottom:8px;font-size:1em;">Automatic Notifications Sent:</h4>
            <ul style="color:#047857;font-size:.9em;margin:0;padding-left:20px;">
              <li>Dashboard updated with completed reference</li>
              <li>Real-time notification sent to applicant</li>
              <li>Email confirmation sent</li>
              <li>Blockchain verification hash generated</li>
            </ul>
          </div>
          <div style="margin-top:15px;padding:15px;background:rgba(59,130,246,.1);border-radius:8px;border-left:3px solid #3b82f6;">
            <h4 style="color:#1e40af;margin-bottom:8px;font-size:1em;">What happens next:</h4>
            <ul style="color:#1d4ed8;font-size:.9em;margin:0;padding-left:20px;">
              <li>Applicant can view the completed reference</li>
              <li>They can add their own context if needed</li>
              <li>They can request additional references from other colleagues</li>
              <li>The reference is now part of their verified professional profile</li>
            </ul>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script type="module" src="./js/gasless.mjs"></script>
  <script type="module" src="./js/main.js"></script>

  <script type="module">
    if (!window.BiconomyService) {
      alert('Error: BiconomyService not loaded. Check js/main.js');
      console.error('BiconomyService undefined');
    }

    // Transaction type para esta página (REFERENCE)
    const TX_TYPE = 'REFERENCE';
    
    // Reference ID (en producción vendría de URL params o backend)
    const REFERENCE_ID = new URLSearchParams(window.location.search).get('refId') || 'demo-ref-' + Date.now();

    // Mostrar quota al cargar
    async function showQuotaStatus() {
      const stats = window.BiconomyService.getUsageStats(REFERENCE_ID);
      const eligibility = window.BiconomyService.checkGaslessEligibility(REFERENCE_ID, TX_TYPE);
      
      const quotaDiv = document.getElementById('quotaIndicator');
      
      if (eligibility.eligible) {
        quotaDiv.className = 'gasless-quota';
        quotaDiv.innerHTML = `
          <h4>✨ Free Gasless Transaction Available</h4>
          <p>This ${TX_TYPE.toLowerCase()} will be processed without gas fees. Free transactions used: ${stats.totalFreeUsed}/4</p>
        `;
      } else {
        quotaDiv.className = 'warning-message';
        quotaDiv.innerHTML = `
          <h4>⚠️ Gasless Limit Reached</h4>
          <p>${eligibility.reason}</p>
          <p style="margin-top:8px;"><a href="/pricing.html" style="color:#991b1b;text-decoration:underline;font-weight:600;">View Pricing Plans →</a></p>
        `;
      }
      
      quotaDiv.style.display = 'block';
    }

    // Star ratings
    document.querySelectorAll('.star-rating').forEach(rating => {
      const stars = rating.querySelectorAll('.star');
      stars.forEach((star) => {
        star.addEventListener('click', () => {
          const value = parseInt(star.dataset.value);
          stars.forEach(s => s.classList.remove('active'));
          for (let i = 0; i < value; i++) stars[i].classList.add('active');
          rating.dataset.rating = value;
        });
        star.addEventListener('mouseover', () => {
          const value = parseInt(star.dataset.value);
          stars.forEach((s, i) => { s.style.color = i < value ? '#f59e0b' : '#d1d5db'; });
        });
      });
      rating.addEventListener('mouseleave', () => {
        const current = parseInt(rating.dataset.rating) || 0;
        stars.forEach((s, i) => { s.style.color = i < current ? '#f59e0b' : '#d1d5db'; });
      });
    });

    // Form submit
    const form = document.getElementById('referenceForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!window.BiconomyService) {
        alert('Service not available');
        return;
      }

      // Validar ratings
      const ratings = document.querySelectorAll('.star-rating');
      for (const r of ratings) {
        if (!r.dataset.rating) { alert('Please rate all KPIs'); return; }
      }

      const applicantAddress = '0x5f0Aebe961B61bD4d835FcDdfA6C2Dcd12FA8192';

      const formData = {
        applicantAddress,
        ratings: Object.fromEntries([...ratings].map(r => [r.dataset.kpi, parseInt(r.dataset.rating)])),
        comments: Object.fromEntries(
          [...document.querySelectorAll('textarea')]
            .filter(t => t.name && t.value.trim())
            .map(t => [t.name, t.value.trim()])
        ),
        timestamp: new Date().toISOString()
      };

      const refId = ethers.utils.id(REFERENCE_ID + applicantAddress + Date.now());
      const dataHash = ethers.utils.id(JSON.stringify(formData));

      submitBtn.disabled = true;
      submitBtn.textContent = '⛓️ Processing transaction...';

      try {
        await window.BiconomyService.initialize();
        const [reviewer] = await window.ethereum.request({ method: 'eth_requestAccounts' });

        // Enviar con tipo de transacción
        const res = await window.BiconomyService.createReferenceGasless(
          refId,
          applicantAddress,
          reviewer,
          dataHash,
          TX_TYPE  // 'REFERENCE'
        );

        // UI success
        submitBtn.style.display = 'none';
        successMessage.style.display = 'block';

        const info = document.createElement('div');
        info.style.cssText = 'margin-top:15px;padding:15px;background:rgba(139,92,246,.1);border-radius:8px;border-left:3px solid #8b5cf6;';
        
        let modeText = res.mode === 'gasless' ? 'GASLESS - No fees paid' : 'DIRECT - User paid gas';
        let quotaInfo = '';
        
        if (res.mode === 'gasless') {
          quotaInfo = `<br><span style="color:#059669;font-weight:600;">✨ ${modeText}</span>
                       <br><small>Free quota remaining: ${res.freeQuotaRemaining || 0} transactions</small>`;
        } else {
          quotaInfo = `<br><span style="color:#dc2626;font-weight:600;">💰 ${modeText}</span>
                       <br><small>Gas paid: ~${res.gasPaid} ETH</small>`;
        }

        info.innerHTML = `
          <h4 style="color:#6b21a8;margin-bottom:8px;font-size:1em;">⛓️ Blockchain Verification (${res.mode.toUpperCase()})</h4>
          <p style="color:#7c3aed;font-size:.9em;word-break:break-all;">
            <strong>Transaction Hash:</strong><br>
            <a href="https://sepolia.basescan.org/tx/${res.transactionHash}" target="_blank" style="color:#8b5cf6;text-decoration:underline;">
              ${res.transactionHash}
            </a>
            ${quotaInfo}
          </p>`;
        successMessage.appendChild(info);

      } catch (err) {
        console.error(err);
        alert('Error submitting reference: ' + (err?.message || err));
        submitBtn.disabled = false;
        submitBtn.textContent = 'Complete & Submit Reference';
      }
    });

    // Auto-save drafts
    const tas = document.querySelectorAll('textarea');
    tas.forEach(t => {
      t.addEventListener('blur', () => {
        const drafts = JSON.parse(localStorage.getItem('referenceDrafts') || '{}');
        drafts[t.name || 'unnamed'] = t.value;
        localStorage.setItem('referenceDrafts', JSON.stringify(drafts));
      });
    });
    
    // Load drafts
    const drafts = JSON.parse(localStorage.getItem('referenceDrafts') || '{}');
    tas.forEach(t => { 
      const k = t.name || 'unnamed'; 
      if (drafts[k]) t.value = drafts[k]; 
    });

    // Mostrar quota al cargar página
    window.addEventListener('load', showQuotaStatus);
  </script>
</body>
</html>