<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HRKey ‚Äì Reference Evaluation</title>

  <script>
    (function () {
      // === Leer par√°metros de URL ===
      const qs = new URLSearchParams(location.search);
      const raw = qs.get("ref") || qs.get("token") || "";
      const payload = qs.get("p") || "";
      const looksOk = /^[A-Za-z0-9_\-:.]{16,}$/.test(raw);
      const token = looksOk ? raw : "";

      // === Base URL din√°mica (local vs prod) ===
      const isLocal =
        location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const BASE_URL = isLocal
        ? "https://hrkey.xyz"
        : location.origin;

      // === Si hay payload (p), decodificarlo ===
      let decodedPayload = null;
      if (payload) {
        try {
          const b64 = payload.replace(/-/g, "+").replace(/_/g, "/");
          const json = decodeURIComponent(escape(atob(b64)));
          decodedPayload = JSON.parse(json);
          if (token && !decodedPayload.id) decodedPayload.id = token;
          console.log("‚úÖ Decoded payload:", decodedPayload);
        } catch (err) {
          console.error("‚ùå Error decoding payload:", err);
        }
      }

      // === Comportamiento final ===
      if (decodedPayload) {
        // Si el link contiene el payload (p), redirige directo a la p√°gina local de evaluaci√≥n
        const localEval = `${BASE_URL}/referee-evaluation-page.html?ref=${encodeURIComponent(
          decodedPayload.id
        )}&p=${encodeURIComponent(payload)}`;
        console.log("üîó Redirecting to full evaluation page with payload:", localEval);
        location.replace(localEval);
      } else if (token) {
        // Fallback: solo token
        const target = `${BASE_URL}/referee-evaluation-page.html?ref=${encodeURIComponent(
          token
        )}`;
        console.log("üîó Redirecting to token-only evaluation page:", target);
        location.replace(target);
      } else {
        // Sin token ni payload ‚Üí fallback a home o aviso
        console.warn("‚ö†Ô∏è Missing token or payload; redirecting to homepage");
        location.replace(`${BASE_URL}/index.html`);
      }
    })();
  </script>

  <noscript>
    <meta http-equiv="refresh" content="0;url=https://hrkey.xyz/index.html">
  </noscript>
</head>
<body>
  <p>Redirecting to the secure evaluation page‚Ä¶</p>
  <noscript>
    <p><a href="https://hrkey.xyz/index.html">Continue</a></p>
  </noscript>
</body>
</html>
