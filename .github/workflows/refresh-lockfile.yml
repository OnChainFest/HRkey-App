name: Refresh lockfile

on:
  workflow_dispatch:
  push:
    branches:
      - chore/next-15-5-10

jobs:
  refresh-lockfile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install (regenerate lockfile)
        run: npm install

      - name: Verify Next.js resolved version >= 15.5.10
        run: |
          node -e "const v=require('./node_modules/next/package.json').version; console.log('next resolved:', v); const [a,b,c]=v.split('.').map(n=>parseInt(n,10)); if(a<15 || (a===15 && (b<5 || (b===5 && c<10)))) { throw new Error('Next.js '+v+' is below 15.5.10'); }"

      - name: Commit lockfile if changed
        run: |
          if [[ -n "$(git status --porcelain package-lock.json)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "chore: regenerate lockfile for next ^15.5.10"
            git push origin HEAD
          else
            echo "No lockfile changes to commit."
          fi

      - name: Build (optional)
        run: npm run build
        continue-on-error: true
