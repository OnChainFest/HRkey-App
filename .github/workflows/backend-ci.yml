# ==============================================================================
# Backend CI Pipeline
# ==============================================================================
# Runs backend tests on every push and PR to ensure code quality and reliability
#
# What this workflow does:
# 1. Checks out the code
# 2. Sets up Node.js 20.x with dependency caching
# 3. Installs dependencies from root package.json
# 4. Runs backend test suite
# 5. Generates test coverage report
#
# Environment:
# - Tests use mocked Supabase and Stripe clients (no real API calls)
# - No secrets required for test execution
# ==============================================================================

name: Backend CI

# Trigger conditions
on:
  # Run on push to any branch
  push:
    branches:
      - '**'
    paths:
      # Only run if backend files changed
      - 'backend/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend-ci.yml'

  # Run on pull requests targeting main or develop branches
  pull_request:
    branches:
      - main
      - develop
    paths:
      # Only run if backend files changed
      - 'backend/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend-ci.yml'

  # Allow manual workflow dispatch
  workflow_dispatch:

# Concurrency: cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Continue running other matrix jobs even if one fails
    strategy:
      fail-fast: false

    steps:
      # ========================================================================
      # Step 1: Checkout repository
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better git operations
          fetch-depth: 0

      # ========================================================================
      # Step 2: Set up Node.js with caching
      # ========================================================================
      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          # Enable npm dependency caching for faster installs
          cache: 'npm'

      # ========================================================================
      # Step 3: Install dependencies from root
      # ========================================================================
      - name: Install dependencies
        run: npm install
        env:
          # Prevent interactive prompts during install
          CI: true

      # ========================================================================
      # Step 4: Run backend tests
      # ========================================================================
      - name: Run backend tests
        run: |
          cd backend
          npm test
        env:
          # CI environment variable signals test environment
          CI: true
          NODE_ENV: test

          # ============================================================
          # ENVIRONMENT VARIABLES (Optional - Tests use mocks)
          # ============================================================
          # The test suite uses mocked Supabase and Stripe clients,
          # so no real API credentials are needed. However, if you want
          # to run integration tests against real services in the future,
          # configure these as GitHub Actions secrets:
          #
          # SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          # SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          # STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          # STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # ============================================================

      # ========================================================================
      # Step 5: Generate test coverage report
      # ========================================================================
      - name: Generate coverage report
        run: |
          cd backend
          npm run test:coverage
        env:
          CI: true
          NODE_ENV: test
        # Continue even if coverage thresholds aren't met
        continue-on-error: false

      # ========================================================================
      # Step 6: Upload coverage report as artifact
      # ========================================================================
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: backend/coverage/
          retention-days: 30

      # ========================================================================
      # Step 7: Display test summary
      # ========================================================================
      - name: Display test summary
        if: always()
        run: |
          echo "‚úÖ Backend CI Pipeline Completed"
          echo ""
          echo "üìä Test Results:"
          echo "- Test suite: backend/tests/"
          echo "- Coverage report: backend/coverage/"
          echo ""
          echo "üîç Review the test output above for details"

      # ========================================================================
      # Optional: Upload coverage to Codecov (uncomment if using Codecov)
      # ========================================================================
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: ./backend/coverage/lcov.info
      #     flags: backend
      #     name: backend-coverage
      #     fail_ci_if_error: false
      #   env:
      #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
