<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HRKey â€“ Request Reference</title>

  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/style.css" rel="stylesheet">
  <link href="./css/responsive.css" rel="stylesheet">

  <style>
    body { background:#0a0a0a; font-family:'Rubik',sans-serif; }
    .page { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    .card { background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,196,199,0.2); padding: 28px; border: 1px solid rgba(0,196,199,0.2); }
    h1 { font-size: 28px; margin: 0 0 8px; color:#ffffff; }
    p.lead { color:#cbd5e1; margin: 0 0 24px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    @media (max-width: 768px){ .row { grid-template-columns: 1fr; } }
    .row-1 { grid-template-columns: 1fr; }
    label { display:block; font-weight:600; color:#00C4C7; margin: 10px 0 6px; }
    input, select, textarea {
      width: 100%; padding: 12px; border: 1px solid rgba(0,196,199,0.3); border-radius: 10px; font-size: 14px;
      background: #0f172a; color: #ffffff;
    }
    input::placeholder, textarea::placeholder { color:#94a3b8; }
    input:focus, select:focus, textarea:focus { outline:none; border-color:#00C4C7; box-shadow:0 0 0 3px rgba(0,196,199,.28); }
    input:disabled { background: #0a0a0a; color: #666666; }
    .actions { margin-top: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn-primary {
      background: linear-gradient(135deg, #00C4C7 0%, #00d2cc 100%);
      border: none; padding: 12px 24px; border-radius: 12px; color: #000000; font-weight:600; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,196,199,0.4);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,196,199,0.6); }
    .btn-secondary { background:transparent; border:2px solid #00C4C7; color:#00C4C7; padding:10px 18px; border-radius:10px; font-weight:600; cursor: pointer; }
    .btn-secondary:hover { background:#00C4C7; color:#000000; }
    .alert { margin-top:16px; padding: 14px 16px; border-radius: 10px; }
    .alert-success { background:rgba(16,185,129,0.1); color:#10b981; border-left:4px solid #10b981; }
    .alert-error { background:rgba(239,68,68,0.1); color:#ef4444; border-left:4px solid #ef4444; }
    .muted { color:#94a3b8; font-size: 12px; }
    .back-link { color: #00C4C7; text-decoration: none; }
    .back-link:hover { color: #00d2cc; }
    .kpi-box { background: rgba(0,196,199,0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #00C4C7; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <a href="./app.html" class="back-link muted">&larr; Back to Dashboard</a>
      <h1>Request a New Reference</h1>
      <p class="lead">Send a request to your manager, colleague, or client.</p>

      <form id="refForm" novalidate>
        <div class="row">
          <div>
            <label for="refereeName">Referee Name *</label>
            <input type="text" id="refereeName" required placeholder="e.g. Ana Manager" autocomplete="name">
          </div>
          <div>
            <label for="refereeEmail">Referee Email *</label>
            <input type="email" id="refereeEmail" required placeholder="e.g. ana@empresa.com" autocomplete="email" inputmode="email">
          </div>
          <div>
            <label for="relationship">Relationship *</label>
            <select id="relationship" required>
              <option value="">Select relationship</option>
              <option value="Direct Manager">Direct Manager</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Colleague">Colleague</option>
              <option value="HR Manager">HR Manager</option>
              <option value="Client">Client</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="company">Company *</label>
            <input type="text" id="company" required placeholder="e.g. Empresa X" autocomplete="organization">
          </div>
          <div>
            <label for="position">Your Position *</label>
            <input type="text" id="position" required placeholder="e.g. Frontend Developer">
          </div>
          <div>
            <label for="wallet">Your Wallet</label>
            <input type="text" id="wallet" disabled placeholder="Wallet from your session">
          </div>
        </div>

        <div class="row row-1">
          <div>
            <label for="message">Personal message (optional)</label>
            <textarea id="message" rows="4" placeholder="Add a short personal note to your referee..."></textarea>
          </div>
        </div>

        <!-- KPIs Section -->
        <div class="row row-1" style="margin-top: 30px;">
          <div class="kpi-box">
            <h3 style="color: #00C4C7; margin: 0 0 10px 0; font-size: 18px;">ðŸ“Š Define KPIs for Evaluation</h3>
            <p style="color: #cbd5e1; font-size: 13px; margin: 0 0 20px 0;">Specify 2â€“3 key performance indicators you'd like the referee to evaluate.</p>

            <div style="margin-bottom: 15px;">
              <label for="kpi1Title">KPI 1: Title *</label>
              <input type="text" id="kpi1Title" required placeholder="e.g. Product Launch Success">
            </div>
            <div style="margin-bottom: 20px;">
              <label for="kpi1Description">KPI 1: Description *</label>
              <input type="text" id="kpi1Description" required placeholder="e.g. Launch 2 major features within Q4 timeline">
            </div>

            <div style="margin-bottom: 15px;">
              <label for="kpi2Title">KPI 2: Title *</label>
              <input type="text" id="kpi2Title" required placeholder="e.g. Team Leadership">
            </div>
            <div style="margin-bottom: 20px;">
              <label for="kpi2Description">KPI 2: Description *</label>
              <input type="text" id="kpi2Description" required placeholder="e.g. Lead cross-functional team of 8+ members effectively">
            </div>

            <div style="margin-bottom: 15px;">
              <label for="kpi3Title">KPI 3: Title (optional)</label>
              <input type="text" id="kpi3Title" placeholder="e.g. Client Satisfaction">
            </div>
            <div>
              <label for="kpi3Description">KPI 3: Description (optional)</label>
              <input type="text" id="kpi3Description" placeholder="e.g. Maintain 95%+ client satisfaction rating">
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn-primary" id="submitBtn">ðŸš€ Send Request</button>
          <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
          <span class="muted" id="statusText"></span>
        </div>
      </form>

      <div id="alertBox"></div>
    </div>
  </div>

  <script>
    // ===== EmailJS creds =====
    const EMAILJS_SERVICE_ID = "service_yvtzlvf";
    const EMAILJS_TEMPLATE_ID = "template_3zat2bq";
    const EMAILJS_PUBLIC_KEY  = "8kTeUTmDNbaWwqDWQ";

    // ===== Helpers UI =====
    function showAlert(msg, type='success') {
      const box = document.getElementById('alertBox');
      box.innerHTML = `<div class="alert ${type==='success'?'alert-success':'alert-error'}">${msg}</div>`;
    }
    function setStatus(msg) {
      document.getElementById('statusText').textContent = msg || '';
    }

    // ===== Session load =====
    function loadSessionOrRedirect() {
      const raw = localStorage.getItem('hrkey_user_data');
      if (!raw) {
        location.replace('./auth.html');
        return null;
      }
      try {
        const user = JSON.parse(raw);
        const w = document.getElementById('wallet');
        if (w && user?.wallet) w.value = user.wallet;
        return user;
      } catch(e) {
        console.error('Invalid hrkey_user_data:', e);
        location.replace('./auth.html');
        return null;
      }
    }

    // ===== Local save of reference (for UI/state only) =====
    function saveReferenceLocal(ref) {
      const list = JSON.parse(localStorage.getItem('hrkey_references') || '[]');
      list.push(ref);
      localStorage.setItem('hrkey_references', JSON.stringify(list));

      const planRaw = localStorage.getItem('hrkey_user_plan');
      if (planRaw) {
        try {
          const plan = JSON.parse(planRaw);
          plan.usage = plan.usage || { referencesUsed: 0 };
          plan.usage.referencesUsed = (plan.usage.referencesUsed || 0) + 1;
          localStorage.setItem('hrkey_user_plan', JSON.stringify(plan));
        } catch(_) {}
      }
    }

    // ===== Load EmailJS on demand =====
    async function ensureEmailJS() {
      if (window.emailjs) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js";
        s.onload = () => { emailjs.init(EMAILJS_PUBLIC_KEY); resolve(); };
        s.onerror = () => reject(new Error('Failed to load emailjs'));
        document.head.appendChild(s);
      });
    }

    // ===== Compute base URL (avoid localhost in outgoing emails) =====
    function computeBaseURL() {
      try {
        if (window.HRKEY_PUBLIC_URL) {
          return window.HRKEY_PUBLIC_URL.replace(/\/$/, '');
        }
        if (typeof process !== 'undefined' && process.env && process.env.NEXT_PUBLIC_BASE_URL) {
          return process.env.NEXT_PUBLIC_BASE_URL.replace(/\/$/, '');
        }
        const hostname = location.hostname;
        const isLocal = ['localhost', '127.0.0.1'].includes(hostname);
        if (isLocal) return 'https://hrkey.xyz'; // fallback seguro en local
        return location.origin.replace(/\/$/, '');
      } catch (e) {
        console.warn('âš ï¸ Error computing base URL:', e);
        return 'https://hrkey.xyz';
      }
    }

    // ===== EmailJS send =====
    async function sendEmailJS(ref, user) {
      await ensureEmailJS();
      const baseURL = computeBaseURL();
      const verificationLink = `${baseURL}/referee-evaluation-page.html?ref=${encodeURIComponent(ref.id)}`;

      const params = {
        to_name: ref.refereeName,
        to_email: ref.refereeEmail,
        requester_name: user?.name || 'HRKey User',
        requester_email: user?.email || 'noreply@hrkey.xyz',
        relationship: ref.relationship,
        company: ref.company,
        position: ref.position,
        message: ref.message || 'No additional message provided',
        reference_id: ref.id,
        verification_link: verificationLink
      };

      console.log('ðŸ”— verification_link:', verificationLink);
      const res = await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
      console.log('âœ… EmailJS SUCCESS:', res);
      return true;
    }

    // ===== Silent KPI capture to backend (non-blocking) =====
    async function sendKpisToBackend(kpis, context){
      try {
        await fetch('/api/kpi-suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kpis,
            position: context?.position || '',
            company: context?.company || '',
            userEmail: context?.userEmail || ''
          })
        });
      } catch(e){
        console.warn('KPI backend capture failed (non-blocking):', e);
      }
    }

    // ===== Submit =====
    async function submitReferenceRequest(e) {
      e.preventDefault();
      const user = loadSessionOrRedirect();
      if (!user) return;

      // Basic front validation
      const requiredIds = ['refereeName','refereeEmail','relationship','company','position','kpi1Title','kpi1Description','kpi2Title','kpi2Description'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el || !el.value.trim()) {
          showAlert('Please fill all required fields.', 'error');
          el?.focus();
          return;
        }
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      const original = submitBtn.textContent;
      submitBtn.textContent = 'â³ Sending...';
      setStatus('Sending requestâ€¦');

      const kpis = [
        {
          title: document.getElementById('kpi1Title').value.trim(),
          description: document.getElementById('kpi1Description').value.trim()
        },
        {
          title: document.getElementById('kpi2Title').value.trim(),
          description: document.getElementById('kpi2Description').value.trim()
        }
      ];
      const kpi3Title = document.getElementById('kpi3Title').value.trim();
      const kpi3Desc = document.getElementById('kpi3Description').value.trim();
      if (kpi3Title && kpi3Desc) {
        kpis.push({ title: kpi3Title, description: kpi3Desc });
      }

      const ref = {
        id: 'ref_' + Date.now(),
        refereeName: document.getElementById('refereeName').value.trim(),
        refereeEmail: document.getElementById('refereeEmail').value.trim(),
        relationship: document.getElementById('relationship').value,
        company: document.getElementById('company').value.trim(),
        position: document.getElementById('position').value.trim(),
        message: document.getElementById('message').value.trim(),
        kpis,
        status: 'pending',
        dateRequested: new Date().toISOString(),
        requestedBy: user.email || ''
      };

      try {
        // 1) EnvÃ­o silencioso de KPIs al backend (no bloquea el resto)
        sendKpisToBackend(kpis, {
          position: ref.position,
          company: ref.company,
          userEmail: user?.email || ''
        });

        // 2) Enviar el correo al referee
        const mailOk = await sendEmailJS(ref, user);

        // 3) Guardar estado local (para UI)
        saveReferenceLocal(ref);

        if (mailOk) {
          showAlert('âœ… Reference request sent successfully! Email delivered.', 'success');
        } else {
          showAlert('âš ï¸ Request saved locally. Email may not have been sent. Check console.', 'error');
        }

        setStatus('');
        setTimeout(()=> location.replace('./app.html'), 1500);

      } catch(err) {
        console.error('âŒ submitReferenceRequest error:', err);
        showAlert('âŒ Unexpected error. Please try again.', 'error');
        setStatus('');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = original;
      }
    }

    // ===== init =====
    window.addEventListener('DOMContentLoaded', () => {
      const user = loadSessionOrRedirect();
      if (!user) return;

      document.getElementById('refForm').addEventListener('submit', submitReferenceRequest);
      document.getElementById('cancelBtn').addEventListener('click', () => location.replace('./app.html'));
    });
  </script>
</body>
</html>
