<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRKey - Sign Up / Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Rubik', Arial, sans-serif; 
            background: linear-gradient(135deg, #000000 0%, #00C4C7 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 40px;
            text-align: center;
        }
        .logo {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .header h1 {
            color: #00C4C7;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            color: #888;
            font-size: 14px;
        }
        .content {
            padding: 40px;
        }

        /* Referee banner (tu original) */
        .referee-banner {
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border-left: 4px solid #00C4C7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }
        .referee-banner.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .referee-banner h3 {
            color: #00C4C7;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .referee-banner p {
            color: #1e293b;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Promo banner (nuevo) */
        .promo-banner {
            background: #f1f5f9;
            border-left: 4px solid #00C4C7;
            padding: 16px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .promo-banner.active { display: block; animation: slideIn .5s ease; }
        .promo-badge { display:inline-block; font-weight:700; color:#0f172a; background:#a7f3d0; border-radius:8px; padding:4px 8px; margin-right:8px; }
        .promo-banner p { color:#1e293b; font-size:14px; line-height:1.6; }
        .promo-tiny { font-size:12px; color:#64748b; margin-top:6px; }

        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Rubik', Arial, sans-serif;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #00C4C7;
        }
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00C4C7 0%, #00d2cc 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,196,199,0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,196,199,0.6);
        }
        .btn-wallet {
            width: 100%;
            padding: 16px;
            background: transparent;
            color: #00C4C7;
            border: 2px solid #00C4C7;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        .btn-wallet:hover {
            background: #00C4C7;
            color: #000;
        }
        .divider {
            text-align: center;
            margin: 25px 0;
            color: #94a3b8;
            font-size: 14px;
            position: relative;
        }
        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e2e8f0;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .benefits {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #e2e8f0;
        }
        .benefit-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #64748b;
        }
        .benefit-icon {
            font-size: 20px;
            margin-right: 12px;
        }
        .footer-note {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üîê</div>
            <h1>Welcome to HRKey</h1>
            <p id="headerSubtitle">Build your verified professional profile</p>
        </div>

        <div class="content">
            <!-- Banner especial para referees (tu original) -->
            <div class="referee-banner" id="refereeBanner">
                <h3>üéâ Thanks for providing a reference!</h3>
                <p>You've seen how HRKey works. Now create your own profile and start building your decentralized professional reputation with blockchain-verified references.</p>
            </div>

            <!-- NUEVO: Banner de cup√≥n aplicado -->
            <div class="promo-banner" id="promoBanner">
                <p>
                    <span class="promo-badge" id="promoCodeBadge">BLKJUNGLE</span>
                    <strong>Promo applied:</strong> PRO free for 1 year ‚Äî <em>card required for renewal</em>.
                </p>
                <p class="promo-tiny">Your discount will be applied automatically at checkout.</p>
            </div>

            <form id="authForm">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" placeholder="Enter your full name" required>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="your.email@company.com" required>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    üöÄ Create Free Account
                </button>
            </form>

            <div class="divider">OR</div>

            <button class="btn-wallet" id="walletBtn">
                ü¶ä Connect with MetaMask
            </button>

            <div class="benefits">
                <div class="benefit-item">
                    <span class="benefit-icon">‚úÖ</span>
                    <span>1 free blockchain-verified reference</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">‚ö°</span>
                    <span>Setup in less than 2 minutes</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">üîê</span>
                    <span>Secure & decentralized profile</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">üåê</span>
                    <span>Share with employers worldwide</span>
                </div>
            </div>

            <div class="footer-note">
                <p>By signing up, you agree to our Terms of Service</p>
                <p style="margin-top: 5px;">Already have an account? <a href="#" style="color: #00C4C7; text-decoration: none;">Sign in</a></p>
            </div>
        </div>
    </div>

    <script>
        // ========= CONFIG EVENTO (ajusta si cambia) =========
        // Activo desde s√°bado hasta martes (UTC), para cubrir escaneos en casa.
        const EVENT_START_UTC = Date.parse("2025-11-08T00:00:00Z");
        const EVENT_END_UTC   = Date.parse("2025-11-12T05:59:00Z"); // cubre martes noche CR (UTC-6 aprox.)
        const DEFAULT_COUPON  = "BLKJUNGLE";

        function isWithinEventWindow() {
            const now = Date.now();
            return now >= EVENT_START_UTC && now <= EVENT_END_UTC;
        }
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        function addOrReplaceQueryParam(name, value) {
            const url = new URL(window.location.href);
            url.searchParams.set(name, value);
            window.history.replaceState({}, "", url.toString());
        }

        // ========= CUP√ìN EFECTIVO =========
        // 1) Usa ?coupon si viene en la URL (QR impreso recomienda /auth?coupon=BLKJUNGLE)
        // 2) Si no viene, auto-aplica solo dentro de la ventana del evento
        let coupon = getQueryParam("coupon");
        if (!coupon && isWithinEventWindow()) {
            coupon = DEFAULT_COUPON;
            addOrReplaceQueryParam("coupon", coupon); // Limpia/normaliza la URL
        }

        // Mostrar banner si hay cup√≥n
        const promoBanner = document.getElementById('promoBanner');
        const promoCodeBadge = document.getElementById('promoCodeBadge');
        if (coupon) {
            promoCodeBadge.textContent = coupon;
            promoBanner.classList.add('active');
            localStorage.setItem('hrkey_coupon', coupon);
        } else {
            promoBanner.classList.remove('active');
            localStorage.removeItem('hrkey_coupon');
        }

        // ========= REFEREE STATUS (tu original) =========
        function checkRefereeStatus() {
            const refereeInfo = localStorage.getItem('hrkey_referee_info');
            if (!refereeInfo) return;
            try {
                const data = JSON.parse(refereeInfo);
                if (data.hasProvidedReference) {
                    document.getElementById('refereeBanner').classList.add('active');
                    document.getElementById('headerSubtitle').textContent = 'Now build your own verified profile!';
                    if (window.gtag) {
                        gtag('event', 'referee_reached_signup', {
                            'event_category': 'conversion',
                            'event_label': 'referee_funnel'
                        });
                    }
                }
            } catch (e) {}
        }

        // ========= FLOW: SIGNUP / WALLET => UPGRADE =========
        function goToUpgrade() {
            const dest = coupon ? `app.html?coupon=${encodeURIComponent(coupon)}` : 'app.html';
            window.location.href = dest;
        }

        // Demo login/signup (manteniendo tu simulaci√≥n)
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Creating account...';

            setTimeout(() => {
                const userData = {
                    name,
                    email,
                    wallet: '0x' + Math.random().toString(16).substr(2, 40),
                    authenticated: true,
                    loginDate: new Date().toISOString(),
                    source: localStorage.getItem('hrkey_referee_info') ? 'referee_conversion' : 'direct_signup'
                };
                localStorage.setItem('hrkey_user_data', JSON.stringify(userData));

                const plan = {
                    plan: 'free',
                    features: { maxReferences: 1, canUseBlockchain: false, canExportPDF: false },
                    usage: { referencesUsed: 0 }
                };
                localStorage.setItem('hrkey_user_plan', JSON.stringify(plan));

                if (window.gtag && userData.source === 'referee_conversion') {
                    gtag('event', 'referee_converted', {
                        'event_category': 'conversion',
                        'event_label': 'signup_completed'
                    });
                }
                console.log('‚úÖ Account created:', userData);

                // NUEVO: ir al upgrade con cup√≥n para Stripe
                window.location.href='/auth.html';
            }, 900);
        });

        // Conectar con MetaMask (demo)
        document.getElementById('walletBtn').addEventListener('click', async () => {
            const walletBtn = document.getElementById('walletBtn');
            walletBtn.disabled = true;
            walletBtn.textContent = '‚è≥ Connecting...';

            setTimeout(() => {
                const userData = {
                    name: 'Web3 User',
                    email: 'user@wallet.xyz',
                    wallet: '0x' + Math.random().toString(16).substr(2, 40),
                    authenticated: true,
                    loginDate: new Date().toISOString(),
                    source: localStorage.getItem('hrkey_referee_info') ? 'referee_conversion_wallet' : 'direct_signup_wallet'
                };
                localStorage.setItem('hrkey_user_data', JSON.stringify(userData));

                const plan = {
                    plan: 'free',
                    features: { maxReferences: 1, canUseBlockchain: false, canExportPDF: false },
                    usage: { referencesUsed: 0 }
                };
                localStorage.setItem('hrkey_user_plan', JSON.stringify(plan));

                console.log('‚úÖ Wallet connected:', userData);
                // NUEVO: ir al upgrade con cup√≥n para Stripe
                window.location.href='/auth.html';
            }, 1200);
        });

        // Check referee status on load
        window.addEventListener('DOMContentLoaded', checkRefereeStatus);
    </script>
   <script type="module" src="/js/wallet-auth.js"></script>
    <script>
  document.getElementById('go-dashboard')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/app.html';
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('authForm');      // ajusta si tu form tiene otro id
    const submitBtn = document.getElementById('submitBtn'); // id del bot√≥n

    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // evita recarga de la misma p√°gina

      // (opcional) lee campos
      const name  = document.getElementById('fullName')?.value?.trim() || '';
      const email = document.getElementById('email')?.value?.trim() || '';

      // (opcional) validaci√≥n m√≠nima
      if (!name || !email) {
        alert('Please fill in your name and email.');
        return;
      }

      submitBtn?.setAttribute('disabled', 'true');
      const oldText = submitBtn?.textContent;
      if (submitBtn) submitBtn.textContent = 'Creating account...';

      try {
        // TODO: aqu√≠ va tu signup real (Supabase/tu API).
        // De momento simulamos una acci√≥n corta:
        await new Promise(r => setTimeout(r, 300));

        // Guarda algo m√≠nimo si quieres
        localStorage.setItem('hrkey_user_data', JSON.stringify({
          name, email, authenticated: true, loginDate: new Date().toISOString()
        }));

        // ‚úÖ al dashboard
        window.location.replace('/app.html');
      } catch (err) {
        console.error('sign-up error:', err);
        alert('Could not create account. Please try again.');
      } finally {
        submitBtn?.removeAttribute('disabled');
        if (submitBtn && oldText) submitBtn.textContent = oldText;
      }
    });

    // Cintur√≥n y tirantes: corrige cualquier <a href="/upgrade"> que haya quedado
    document.querySelectorAll('a[href="/upgrade"]').forEach(a => a.setAttribute('href', '/app.html'));
  });
</script>
<script>
(function () {
  function ready() {
    const form = document.getElementById('authForm');
    const btn  = document.getElementById('submitBtn');
    if (!form) return;

    // 1) Evita que el form recargue /auth
    form.setAttribute('novalidate', 'true');
    form.setAttribute('action', '/app.html'); // por si alg√∫n script lee action
    form.setAttribute('method', 'get');

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      window.location.replace('/app.html');
    }, { capture: true });

    // 2) Si el bot√≥n existe, vuelve el bot√≥n "no-submit" y fuerza redirect por click
    if (btn) {
      btn.setAttribute('type', 'button'); // evita submit nativo
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        window.location.replace('/app.html');
      }, { capture: true });
    }

    // 3) Por si qued√≥ alg√∫n enlace a /upgrade
    document.querySelectorAll('a[href="/upgrade"]').forEach(a => a.setAttribute('href', '/app.html'));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ready);
  } else {
    ready();
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('authForm');
  const btn = document.getElementById('submitBtn');
  if (!form || !btn) return;

  // Evita que el form haga submit tradicional
  form.addEventListener('submit', function (e) {
    e.preventDefault();
    window.location.href = '/app.html';
  });

  // Cambia el tipo del bot√≥n a "button" para evitar submits duplicados
  btn.type = 'button';
  btn.addEventListener('click', function (e) {
    e.preventDefault();
    window.location.href = '/app.html';
  });
});
</script>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ‚ö†Ô∏è Usa tus variables reales (o lee de window.__ENV__/meta tags)
  const SUPABASE_URL = "https://<TU-PROYECTO>.supabase.co";
  const SUPABASE_ANON_KEY = "<TU-ANON-KEY>";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 1) Si viene de magic link: intercambia el code por sesi√≥n
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");
  const errorDesc = url.searchParams.get("error_description");

  if (errorDesc) {
    console.error("Auth error:", errorDesc);
    // Muestra un mensaje si quer√©s‚Ä¶
  }

  if (code) {
    try {
      // Intercambio de c√≥digo -> sesi√≥n
      const { error } = await supabase.auth.exchangeCodeForSession({ code });
      if (error) {
        console.error("exchangeCodeForSession error:", error);
      } else {
        // Limpia la URL (quita ?code=...) y manda a /app
        const next = url.searchParams.get("next") || "/app";
        window.history.replaceState({}, document.title, "/auth");
        window.location.replace(next);
      }
    } catch (e) {
      console.error("Exchange failed:", e);
    }
  } else {
    // 2) Si ya hay sesi√≥n, mand√° a /app directamente
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      window.location.replace("/app");
    }
  }

  // 3) Cup√≥n (opcional)
  const coupon = (url.searchParams.get("coupon") || "").toUpperCase();
  if (coupon === "BLKJUNGLE") {
    const until = new Date(Date.now() + 30*24*60*60*1000).toISOString();
    localStorage.setItem("hrkey_premium_until", until);
    localStorage.setItem("hrkey_coupon", coupon);
    // Banner visible
    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;left:0;right:0;top:0;z-index:9999;background:#00C4C7;color:#fff;padding:10px 14px;text-align:center;font-weight:600";
    bar.textContent = "üéüÔ∏è Acceso Premium HRKey activado por 30 d√≠as (Blockchain Jungle)";
    document.body.appendChild(bar);
  }
</script>

</body>
</html>
